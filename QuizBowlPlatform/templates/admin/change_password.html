{% extends "admin/base.html" %}

{% block page_title %}{% if forced_change %}Change Your Password{% else %}Change Password{% endif %}{% endblock %}

{% block admin_content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-key me-2"></i>
                    {% if forced_change %}
                        Change Your Password
                    {% else %}
                        Change Password
                    {% endif %}
                </h5>
            </div>
            <div class="card-body">
                {% if forced_change %}
                <div class="alert alert-warning mb-4">
                    <h5><i class="fas fa-exclamation-triangle me-2"></i>Password Change Required</h5>
                    <p class="mb-0">You must change your password before continuing.</p>
                </div>
                {% endif %}
                
                {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        {% for category, message in messages %}
                            <div class="alert alert-{{ category }} alert-dismissible fade show mb-4" role="alert">
                                <i class="fas {% if category == 'success' %}fa-check-circle{% elif category == 'danger' %}fa-exclamation-circle{% else %}fa-info-circle{% endif %} me-2"></i>
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                            </div>
                        {% endfor %}
                    {% endif %}
                {% endwith %}
                
                <form method="POST" action="{{ url_for('admin.change_password') }}" class="needs-validation" novalidate>
                    {{ form.hidden_tag() }}
                    {% if not forced_change %}
                    <div class="mb-3">
                        {{ form.current_password.label(class="form-label") }}
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-lock"></i></span>
                            {{ form.current_password(class="form-control" + (' is-invalid' if form.current_password.errors else '')) }}
                            {% if form.current_password.errors %}
                                <div class="invalid-feedback">
                                    {{ form.current_password.errors[0] }}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                    
                    <div class="mb-3">
                        {{ form.new_password.label(class="form-label") }}
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-key"></i></span>
                            {{ form.new_password(class="form-control" + (' is-invalid' if form.new_password.errors else '')) }}
                            {% if form.new_password.errors %}
                                <div class="invalid-feedback">
                                    {{ form.new_password.errors[0] }}
                                </div>
                            {% endif %}
                        </div>
                        <div class="form-text">
                            <small class="text-muted">
                                <i class="fas fa-info-circle me-1"></i>
                                Use at least 8 characters with a mix of letters, numbers, and symbols.
                            </small>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        {{ form.confirm_password.label(class="form-label") }}
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-key"></i></span>
                            {{ form.confirm_password(class="form-control" + (' is-invalid' if form.confirm_password.errors else '')) }}
                            {% if form.confirm_password.errors %}
                                <div class="invalid-feedback">
                                    {{ form.confirm_password.errors[0] }}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        {% if not forced_change %}
                        <a href="{{ url_for('admin.dashboard') }}" class="btn btn-outline-secondary me-md-2">
                            <i class="fas fa-times me-1"></i> Cancel
                        </a>
                        {% endif %}
                        {{ form.submit(class="btn btn-primary") }}
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
// Form validation
(function () {
  'use strict'
  
  // Fetch all the forms we want to apply custom Bootstrap validation styles to
  var forms = document.querySelectorAll('.needs-validation')
  
  // Password strength indicator
  const password = document.getElementById('new_password');
  const passwordFeedback = document.createElement('div');
  password.parentNode.insertBefore(passwordFeedback, password.nextSibling);
  
  // Check password strength
  function checkPasswordStrength(password) {
    let strength = 0;
    
    // Length check
    if (password.length >= 8) strength++;
    
    // Contains number
    if (/\d/.test(password)) strength++;
    
    // Contains lowercase
    if (/[a-z]/.test(password)) strength++;
    
    // Contains uppercase
    if (/[A-Z]/.test(password)) strength++;
    
    // Contains special char
    if (/[^A-Za-z0-9]/.test(password)) strength++;
    
    return strength;
  }
  
  // Update password strength indicator
  password.addEventListener('input', function() {
    const strength = checkPasswordStrength(this.value);
    const strengthText = ['Very Weak', 'Weak', 'Fair', 'Good', 'Strong', 'Very Strong'][strength];
    const strengthClass = ['danger', 'warning', 'info', 'success', 'success', 'success'][strength];
    
    passwordFeedback.className = `form-text text-${strengthClass}`;
    passwordFeedback.innerHTML = `
      <i class="fas fa-${strength >= 3 ? 'check' : 'exclamation'}-circle me-1"></i>
      Strength: <strong>${strengthText}</strong>${this.value ? '' : ' (enter a password)'}
    `;
  });
  
  // Loop over forms and prevent submission
  Array.prototype.slice.call(forms)
    .forEach(function (form) {
      form.addEventListener('submit', function (event) {
        if (!form.checkValidity()) {
          event.preventDefault()
          event.stopPropagation()
        }
        
        // Check if passwords match
        const password = document.getElementById('new_password')
        const confirm = document.getElementById('confirm_password')
        
        if (password.value !== confirm.value) {
          confirm.setCustomValidity("Passwords must match")
          confirm.reportValidity()
          event.preventDefault()
          event.stopPropagation()
        } else {
          confirm.setCustomValidity('')
        }
        
        form.classList.add('was-validated')
      }, false)
    })
})()
</script>
{% endblock %}
