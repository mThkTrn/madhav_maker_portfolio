{% extends "admin/base.html" %}

{% block page_title %}
  Scorecard Editor: {{ game.name or ("Game " ~ game.id) }}
  <a href="{{ url_for('admin.tournament_details', tournament_id=tournament.id) }}" class="btn btn-outline-secondary btn-sm ms-2">
    <i class="fas fa-arrow-left me-1"></i> Back to Tournament
  </a>
{% endblock %}

{% block admin_content %}
<div class="container-fluid">
  <div class="row mb-4">
    <div class="col-md-12">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0">
            {{ team1_name }} vs {{ team2_name }}
            <span class="badge bg-primary ms-2">
              {% if game.stage_id %}
                Stage {{ game.stage_id }}
              {% else %}
                Stage 1
              {% endif %}
              - Round {{ game.round_number }}
              {% if game.match_number %}- Match {{ game.match_number }}{% endif %}
            </span>
          </h5>
          <div>
            <button id="finalizeBtn" class="btn btn-success">
              <i class="fas fa-flag-checkered me-1"></i> Finalize Scorecard
            </button>
          </div>
        </div>
        <div class="card-body">
          <div class="row mb-4">
            <div class="col-md-6">
              <h6>Team 1: {{ team1_name }}</h6>
              <div class="player-list">
                {% for player in team1_players %}
                <span class="badge bg-light text-dark me-1 mb-1">
                  {{ player.name }}{% if player.number %} ({{ player.number }}){% endif %}
                </span>
                {% endfor %}
              </div>
            </div>
            <div class="col-md-6">
              <h6>Team 2: {{ team2_name }}</h6>
              <div class="player-list">
                {% for player in team2_players %}
                <span class="badge bg-light text-dark me-1 mb-1">
                  {{ player.name }}{% if player.number %} ({{ player.number }}){% endif %}
                </span>
                {% endfor %}
              </div>
            </div>
          </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-bordered table-hover" id="scorecardTable">
              <thead class="table-light">
                <tr>
                  <th style="width: 50px;">#</th>
                  <th style="min-width: 300px;">Team 1 ({{ team1_name }})</th>
                  <th style="min-width: 300px;">Team 2 ({{ team2_name }})</th>
                  <th style="min-width: 200px;">Bonus</th>
                  <th style="width: 100px;">Actions</th>
                </tr>
              </thead>
              <tbody id="scorecardBody">
                {% for i in range(scorecard|length) %}
                {% set tossup = scorecard[i] %}
                <tr data-tossup-index="{{ i }}">
                  <td class="align-middle text-center">
                    <strong>{{ i + 1 }}</strong>
                  </td>
                  <td>
                    <div class="team-answers" data-team="team1" data-tossup-index="{{ i }}">
                      {% for player in team1_players %}
                      <div class="input-group mb-2">
                        <select class="form-select player-score" 
                                data-player-id="{{ player.id }}" 
                                data-tossup-index="{{ i }}">
                          <option value="0">0 - {{ player.name }}{% if player.number %} ({{ player.number }}){% endif %}</option>
                          <option value="-5" {% if tossup.team1[player.id|string] == -5 %}selected{% endif %}>-5 - {{ player.name }}</option>
                          <option value="10" {% if tossup.team1[player.id|string] == 10 %}selected{% endif %}>10 - {{ player.name }}</option>
                          <option value="15" {% if tossup.team1[player.id|string] == 15 %}selected{% endif %}>15 - {{ player.name }}</option>
                        </select>
                      </div>
                      {% endfor %}
                      <div class="active-players mt-2 p-2 border rounded">
                        <small class="text-muted d-block mb-1">Active Players:</small>
                        <div class="d-flex flex-wrap">
                          {% for player in team1_players %}
                          <div class="form-check form-check-inline me-2">
                            <input class="form-check-input active-player" 
                                   type="checkbox" 
                                   data-tossup-index="{{ i }}"
                                   data-team="team1"
                                   data-player-id="{{ player.id }}"
                                   {% if not tossup.team1Players or tossup.team1Players[loop.index0] == 1 %}checked{% endif %}>
                            <label class="form-check-label small">
                              {{ player.name.split()|last|first }}{{ player.name.split()[-1]|first if player.name.split()|length > 1 else '' }}
                            </label>
                          </div>
                          {% endfor %}
                        </div>
                      </div>
                    </div>
                  </td>
                  <td>
                    <div class="team-answers" data-team="team2" data-tossup-index="{{ i }}">
                      {% for player in team2_players %}
                      <div class="input-group mb-2">
                        <select class="form-select player-score" 
                                data-player-id="{{ player.id }}" 
                                data-tossup-index="{{ i }}">
                          <option value="0">0 - {{ player.name }}{% if player.number %} ({{ player.number }}){% endif %}</option>
                          <option value="-5" {% if tossup.team2[player.id|string] == -5 %}selected{% endif %}>-5 - {{ player.name }}</option>
                          <option value="10" {% if tossup.team2[player.id|string] == 10 %}selected{% endif %}>10 - {{ player.name }}</option>
                          <option value="15" {% if tossup.team2[player.id|string] == 15 %}selected{% endif %}>15 - {{ player.name }}</option>
                        </select>
                      </div>
                      {% endfor %}
                      <div class="active-players mt-2 p-2 border rounded">
                        <small class="text-muted d-block mb-1">Active Players:</small>
                        <div class="d-flex flex-wrap">
                          {% for player in team2_players %}
                          <div class="form-check form-check-inline me-2">
                            <input class="form-check-input active-player" 
                                   type="checkbox" 
                                   data-tossup-index="{{ i }}"
                                   data-team="team2"
                                   data-player-id="{{ player.id }}"
                                   {% if not tossup.team2Players or tossup.team2Players[loop.index0] == 1 %}checked{% endif %}>
                            <label class="form-check-label small">
                              {{ player.name.split()|last|first }}{{ player.name.split()[-1]|first if player.name.split()|length > 1 else '' }}
                            </label>
                          </div>
                          {% endfor %}
                        </div>
                      </div>
                    </div>
                  </td>
                  <td>
                    <div class="form-group">
                      <div class="input-group mb-2">
                        <span class="input-group-text">{{ team1_name }}</span>
                        <input type="number" 
                               class="form-control bonus-points" 
                               data-team="team1" 
                               data-tossup-index="{{ i }}" 
                               value="{{ tossup.team1Bonus }}" 
                               min="0" 
                               step="10">
                      </div>
                      <div class="input-group">
                        <span class="input-group-text">{{ team2_name }}</span>
                        <input type="number" 
                               class="form-control bonus-points" 
                               data-team="team2" 
                               data-tossup-index="{{ i }}" 
                               value="{{ tossup.team2Bonus }}" 
                               min="0" 
                               step="10">
                      </div>
                    </div>
                  </td>
                  <td class="align-middle">
                    <button type="button" class="btn btn-sm btn-outline-danger remove-question" data-tossup-index="{{ i }}">
                      <i class="fas fa-trash"></i> Remove
                    </button>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
              <tfoot class="table-light">
                <tr>
                  <th>Totals</th>
                  <th id="team1Total">0</th>
                  <th id="team2Total">0</th>
                  <th id="bonusTotal">-</th>
                  <th></th>
                </tr>
                <tr>
                  <th>Final Score</th>
                  <th id="team1Final">0</th>
                  <th id="team2Final">0</th>
                  <th>
                    <select class="form-select" id="gameResult">
                      <option value="0" {% if game.result == 0 %}selected{% endif %}>No Result</option>
                      <option value="1" {% if game.result == 1 %}selected{% endif %}>Team 1 Wins</option>
                      <option value="2" {% if game.result == 2 %}selected{% endif %}>Team 2 Wins</option>
                      <option value="-1" {% if game.result == -1 %}selected{% endif %}>Tie</option>
                    </select>
                  </th>
                  <th></th>
                </tr>
              </tfoot>
            </table>
          </div>
          
          <div class="d-flex justify-content-start mt-4">
            <button id="addQuestionBtn" class="btn btn-outline-primary">
              <i class="fas fa-plus me-1"></i> Add Question
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Add Question Modal -->
<div class="modal fade" id="addQuestionModal" tabindex="-1" aria-labelledby="addQuestionModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addQuestionModalLabel">Add New Question</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label for="newQuestionText" class="form-label">Question Text</label>
          <textarea class="form-control" id="newQuestionText" rows="4"></textarea>
        </div>
        <div class="mb-3">
          <label for="newQuestionPosition" class="form-label">Position</label>
          <select class="form-select" id="newQuestionPosition">
            <option value="-1">At the end</option>
            {% for i in range(1, questions|length + 1) %}
            <option value="{{ i }}">After question {{ i }}</option>
            {% endfor %}
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="confirmAddQuestion">Add Question</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
  try {
    // Initialize event listeners
    initializeEventListeners();
    
    // Calculate initial totals
    calculateTotals();
    
    // Initialize tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.forEach(function (tooltipTriggerEl) {
      return new bootstrap.Tooltip(tooltipTriggerEl);
    });
  } catch (error) {
    console.error('Error initializing scorecard:', error);
  }
});

// Initialize tooltips
var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
  return new bootstrap.Tooltip(tooltipTriggerEl);
});

// Calculate totals
function calculateTotals() {
  const scorecard = [];
  let team1TossupTotal = 0;
  let team2TossupTotal = 0;
  let team1BonusTotal = 0;
  let team2BonusTotal = 0;
  
  // Process each tossup
  document.querySelectorAll('tr[data-tossup-index]').forEach(row => {
    const tossupIndex = parseInt(row.dataset.tossupIndex);
    const tossupData = {
      team1: {},
      team2: {},
      team1Bonus: 0,
      team2Bonus: 0,
      team1Players: [],
      team2Players: [],
      buzzes: {}
    };
    
    // Process team 1 answers and active players
    const team1Answers = row.querySelector('[data-team="team1"]');
    if (team1Answers) {
      // Process active players first
      const activeCheckboxes = team1Answers.querySelectorAll('.active-player[data-team="team1"]');
      tossupData.team1Players = Array.from(activeCheckboxes).map(cb => cb.checked ? 1 : 0);
      
      // Process player scores
      team1Answers.querySelectorAll('.player-score').forEach(select => {
        const playerId = select.dataset.playerId;
        const points = parseInt(select.value) || 0;
        if (points !== 0) {
          tossupData.team1[playerId] = points;
          team1TossupTotal += points;
        }
      });
    }
    
    // Process team 2 answers and active players
    const team2Answers = row.querySelector('[data-team="team2"]');
    if (team2Answers) {
      // Process active players first
      const activeCheckboxes = team2Answers.querySelectorAll('.active-player[data-team="team2"]');
      tossupData.team2Players = Array.from(activeCheckboxes).map(cb => cb.checked ? 1 : 0);
      
      // Process player scores
      team2Answers.querySelectorAll('.player-score').forEach(select => {
        const playerId = select.dataset.playerId;
        const points = parseInt(select.value) || 0;
        if (points !== 0) {
          tossupData.team2[playerId] = points;
          team2TossupTotal += points;
        }
      });
    }
    
    // Process bonus points
    const team1BonusInput = row.querySelector('.bonus-points[data-team="team1"]');
    const team2BonusInput = row.querySelector('.bonus-points[data-team="team2"]');
    
    if (team1BonusInput) {
      const bonus = parseInt(team1BonusInput.value) || 0;
      tossupData.team1Bonus = bonus;
      team1BonusTotal += bonus;
    }
    
    if (team2BonusInput) {
      const bonus = parseInt(team2BonusInput.value) || 0;
      tossupData.team2Bonus = bonus;
      team2BonusTotal += bonus;
    }
    
    scorecard.push(tossupData);
  });
  
  const team1Total = team1TossupTotal + team1BonusTotal;
  const team2Total = team2TossupTotal + team2BonusTotal;
  
  // Update the UI
  document.getElementById('team1Total').textContent = team1TossupTotal;
  document.getElementById('team2Total').textContent = team2TossupTotal;
  document.getElementById('bonusTotal').textContent = team1BonusTotal + team2BonusTotal;
  document.getElementById('team1Final').textContent = team1Total;
  document.getElementById('team2Final').textContent = team2Total;
  
  // Update game result if needed
  const gameResult = document.getElementById('gameResult');
  if (team1Total > team2Total) {
    gameResult.value = '1';
  } else if (team2Total > team1Total) {
    gameResult.value = '2';
  } else if (team1Total > 0) {
    gameResult.value = '-1';
  }
  
  return scorecard;
}

// Enable/disable bonus points based on bonus team selection
document.addEventListener('change', function(e) {
  if (e.target.classList.contains('bonus-team')) {
    const bonusPoints = e.target.closest('td').querySelector('.bonus-points');
    if (e.target.value) {
      bonusPoints.disabled = false;
    } else {
      bonusPoints.disabled = true;
      bonusPoints.value = '0';
    }
    calculateTotals();
  } else if (e.target.classList.contains('team1-answer') || 
             e.target.classList.contains('team2-answer') ||
             e.target.classList.contains('bonus-points')) {
    calculateTotals();
  }
});

// Save scorecard
async function saveScorecard(finalize = false) {
  const scorecard = calculateTotals();
  const result = document.getElementById('gameResult').value;
  
  try {
    const response = await fetch(`/admin/tournament/{{ tournament.id }}/game/{{ game.id }}/scorecard`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': '{{ csrf_token() }}'
      },
      body: JSON.stringify({
        scorecard: scorecard,
        result: result
      })
    });
    
    const data = await response.json();
    
    if (response.ok) {
      // Update the displayed scores with the server-calculated values
      document.getElementById('team1Final').textContent = data.team1_score || 0;
      document.getElementById('team2Final').textContent = data.team2_score || 0;
      
      if (finalize) {
        window.location.href = `{{ url_for('admin.tournament_details', tournament_id=tournament.id) }}`;
      } else {
        // Show success message
        const toast = document.createElement('div');
        toast.className = 'position-fixed bottom-0 end-0 p-3';
        toast.innerHTML = `
          <div class="toast show" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header bg-success text-white">
              <strong class="me-auto">Success</strong>
              <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body">
              Scorecard saved successfully!
            </div>
          </div>
        `;
        document.body.appendChild(toast);
        setTimeout(() => {
          toast.remove();
        }, 3000);
      }
    } else {
      throw new Error(data.message || 'Failed to save scorecard');
    }
  } catch (error) {
    console.error('Error saving scorecard:', error);
    alert(`Error: ${error.message}`);
  }
}

// Update question numbers
function updateQuestionNumbers() {
  const rows = document.querySelectorAll('#scorecardBody tr');
  rows.forEach((row, index) => {
    const numberCell = row.querySelector('td:first-child strong');
    if (numberCell) {
      numberCell.textContent = index + 1;
    }
    
    // Update all data-tossup-index attributes
    row.setAttribute('data-tossup-index', index);
    row.querySelectorAll('[data-tossup-index]').forEach(el => {
      el.setAttribute('data-tossup-index', index);
    });
  });
}

// Add question
function addNewQuestionRow() {
  const tbody = document.getElementById('scorecardBody');
  const newIndex = tbody.children.length;
  
  // Create a new row by cloning the first row
  const firstRow = tbody.firstElementChild;
  if (!firstRow) return;
  
  const newRow = firstRow.cloneNode(true);
  
  // Update all data attributes and values
  newRow.setAttribute('data-tossup-index', newIndex);
  
  // Reset all form elements
  newRow.querySelectorAll('select, input').forEach(el => {
    if (el.type === 'select-one') {
      el.selectedIndex = 0;
    } else if (el.type === 'number') {
      el.value = '0';
    } else if (el.type === 'checkbox') {
      el.checked = true;
    }
  });
  
  // Add the new row to the table
  tbody.appendChild(newRow);
  
  // Update question numbers
  updateQuestionNumbers();
  
  // Recalculate totals
  calculateTotals();
}

// Initialize event listeners
function initializeEventListeners() {
  // Add question button
  const addButton = document.getElementById('addQuestionBtn');
  if (addButton) {
    addButton.addEventListener('click', addNewQuestionRow);
  }
  
  // Remove question
  document.addEventListener('click', function(e) {
    if (e.target.closest('.remove-question')) {
      const button = e.target.closest('.remove-question');
      const row = button.closest('tr');
      
      // Only remove if there's more than one question
      if (document.querySelectorAll('#scorecardBody tr').length > 1) {
        row.remove();
        updateQuestionNumbers();
        calculateTotals();
      } else {
        alert('You must have at least one question in the scorecard.');
      }
    }
  });
  
  // Add input listeners for number inputs to update totals as user types
  document.addEventListener('input', (e) => {
    if (e.target.matches('.bonus-points') || 
        e.target.matches('.player-score') ||
        e.target.matches('.bonus-team')) {
      calculateTotals();
    }
  });
  
  // Handle game result change
  const gameResult = document.getElementById('gameResult');
  if (gameResult) {
    gameResult.addEventListener('change', calculateTotals);
  }
  
  // Finalize button
  const finalizeBtn = document.getElementById('finalizeBtn');
  if (finalizeBtn) {
    finalizeBtn.addEventListener('click', () => saveScorecard(true));
  }
  
}
</script>
{% endblock %}
