<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="csrf-token" content="{{ csrf_token() }}">
  <title>Tournament Details | LIQBA</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen flex flex-col">
  <!-- Navbar -->
  <nav class="bg-gray-800 text-white p-4">
    <div class="container mx-auto flex justify-between">
      <a href="{{ url_for('index') }}" class="font-bold hover:underline">LIQBA</a>
      <div>
        <a href="{{ url_for('admin.dashboard') }}" class="px-3 hover:underline">Dashboard</a>
        <a href="{{ url_for('admin.logout') }}" class="px-3 hover:underline">Logout</a>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <main class="container mx-auto flex-grow p-6">
    <div class="max-w-5xl mx-auto">
      <!-- Tournament Info Card -->
      <div class="bg-white p-6 rounded shadow mb-6">
        <div class="flex justify-between items-start mb-4">
          <h2 class="text-3xl font-bold">{{ tournament.name }}</h2>
          <a href="{{ url_for('admin.list_tournament_games', tournament_id=tournament.id) }}" 
             class="bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded-lg flex items-center">
            <i class="fas fa-list-ol mr-2"></i> View All Games
          </a>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <p><span class="font-semibold">Date:</span> {{ tournament.date }}</p>
          <p><span class="font-semibold">Location:</span> {{ tournament.location }}</p>
          <p><span class="font-semibold">Password:</span> {{ tournament.password }}</p>
        </div>
      </div>

      <!-- Tab Navigation -->
      <div class="border-b border-gray-200 mb-6">
        <nav class="-mb-px flex space-x-8" aria-label="Tabs">
          <button onclick="showTab('overview')" id="overview-tab" class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-blue-500 text-blue-600">
            Overview
          </button>
          <button onclick="showTab('readers')" id="readers-tab" class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">
            Reader Management
          </button>
          <button onclick="showTab('rooms')" id="rooms-tab" class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">
            Room Management
          </button>
          <button onclick="showTab('teams')" id="teams-tab" class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">
            Team Management
          </button>
          <button onclick="showTab('stages')" id="stages-tab" class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">
            Tournament Stages
          </button>
          <button onclick="showTab('packets')" id="packets-tab" class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">
            Packets
          </button>
          <button onclick="showTab('protests')" id="protests-tab" class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">
            Protests
          </button>
        </nav>
      </div>

      <!-- Tab Content -->
      <div class="tab-content">
        <!-- Overview Tab -->
        <div id="overview-tab-content" class="tab-pane">
          <!-- Alerts Section -->
          <div class="mb-8" id="alerts-container">
        <div class="bg-white shadow overflow-hidden sm:rounded-lg">
          <div class="px-4 py-5 sm:px-6 border-b border-gray-200">
            <div class="flex justify-between items-center">
              <h3 class="text-lg leading-6 font-medium text-gray-900">Active Alerts</h3>
              <button id="refreshAlertsBtn" class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                <i class="bi bi-arrow-clockwise"></i> Refresh
              </button>
            </div>
          </div>
          <div class="bg-white overflow-hidden">
            <div id="alerts-list" class="divide-y divide-gray-200">
              <!-- Alerts will be loaded here by JavaScript -->
              <div class="p-4 text-center text-gray-500">Loading alerts...</div>
            </div>
          </div>
        </div>
      </div>
        </div> <!-- End Overview Tab -->

        <!-- Room Management Tab -->
        <div id="rooms-tab-content" class="tab-pane hidden">
          <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold">Room Management</h2>
            <a href="{{ url_for('admin.manage_rooms', tournament_id=tournament.id) }}" 
               class="bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded-lg flex items-center">
              <i class="fas fa-door-open mr-2"></i> Manage Room Aliases
            </a>
          </div>
          
          <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h3 class="text-xl font-semibold mb-4">Current Room Assignments</h3>
            
            {% set reader_rooms = {}
                %}{% for assignment in tournament.reader_assignments %}
                    {% if assignment.room_number %}
                        {% set _ = reader_rooms.setdefault(assignment.room_number, []).append(assignment.reader) %}
                    {% endif %}
                {% endfor %}
            
            {% if reader_rooms %}
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    {% for room_number, readers in reader_rooms|dictsort %}
                        <div class="border rounded-lg p-4">
                            <div class="font-semibold text-lg mb-2">
                                {% set room_name = get_room_display_name(tournament.id, room_number) %}
                                {{ room_name }}
                                <span class="text-sm text-gray-500 ml-2">(Room {{ room_number }})</span>
                            </div>
                            {% if readers %}
                                <div class="mt-2">
                                    <div class="text-sm text-gray-600 mb-1">Assigned Readers:</div>
                                    <ul class="list-disc pl-5">
                                        {% for reader in readers %}
                                            <li>{{ reader.email }}</li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            {% else %}
                                <p class="text-sm text-gray-500 italic">No readers assigned</p>
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="text-center py-8 text-gray-500">
                    <p class="mb-4">No room assignments have been made yet.</p>
                    <p>Assign readers to rooms in the Reader Management tab.</p>
                </div>
            {% endif %}
          </div>
        </div>
        
        <!-- Room Management Tab -->
        <div id="rooms-tab-content" class="tab-pane hidden">
          <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold">Room Management</h2>
            <a href="{{ url_for('admin.manage_rooms', tournament_id=tournament.id) }}" 
               class="bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded-lg flex items-center">
              <i class="fas fa-door-open mr-2"></i> Manage Room Aliases
            </a>
          </div>
          
          <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h3 class="text-xl font-semibold mb-4">Current Room Assignments</h3>
            
            {% set reader_rooms = {}
                %}{% for assignment in tournament.reader_assignments %}
                    {% if assignment.room_number %}
                        {% set _ = reader_rooms.setdefault(assignment.room_number, []).append(assignment.reader) %}
                    {% endif %}
                {% endfor %}
            
            {% if reader_rooms %}
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    {% for room_number, readers in reader_rooms|dictsort %}
                        <div class="border rounded-lg p-4">
                            <div class="font-semibold text-lg mb-2">
                                {% set room_name = get_room_display_name(tournament.id, room_number) %}
                                {{ room_name }}
                                <span class="text-sm text-gray-500 ml-2">(Room {{ room_number }})</span>
                            </div>
                            {% if readers %}
                                <div class="mt-2">
                                    <div class="text-sm text-gray-600 mb-1">Assigned Readers:</div>
                                    <ul class="list-disc pl-5">
                                        {% for reader in readers %}
                                            <li>{{ reader.email }}</li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            {% else %}
                                <p class="text-sm text-gray-500 italic">No readers assigned</p>
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="text-center py-8 text-gray-500">
                    <p class="mb-4">No room assignments have been made yet.</p>
                    <p>Assign readers to rooms in the Reader Management tab.</p>
                </div>
            {% endif %}
          </div>
        </div>
        
        <!-- Reader Management Tab -->
        <div id="readers-tab-content" class="tab-pane hidden">
          <h2 class="text-3xl font-bold mb-4">Reader Management</h2>
        
        <!-- Assigned Readers List -->
        <div class="mb-6">
          <h4 class="text-xl font-semibold mb-3">Assigned Readers</h4>
          {% if tournament.reader_assignments %}
            <div class="space-y-2">
              {% for assignment in tournament.reader_assignments %}
                <div class="flex justify-between items-center p-3 bg-gray-50 rounded">
                  <div>
                    <span class="font-medium">{{ assignment.reader.email }}</span>
                    <span class="text-sm text-gray-500 ml-2">(Room {{ assignment.room_number }})</span>
                  </div>
                  <form method="POST" action="{{ url_for('admin.remove_reader', tournament_id=tournament.id, reader_id=assignment.reader.id) }}" class="inline">
                    <button type="submit" class="text-red-500 hover:text-red-700" 
                            onclick="return confirm('Are you sure you want to remove this reader from the tournament?')">
                      <i class="bi bi-x-circle"></i> Remove
                    </button>
                  </form>
                </div>
              {% endfor %}
            </div>
          {% else %}
            <p class="text-gray-500">No readers assigned to this tournament yet.</p>
          {% endif %}
        </div>
        
        <!-- Assign New Reader Form -->
        <div>
          <h4 class="text-xl font-semibold mb-3">Assign New Reader</h4>
          <form method="POST" action="{{ url_for('admin.assign_reader', tournament_id=tournament.id) }}" class="space-y-3">
            {{ form.hidden_tag() if form }}
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Reader's Email</label>
                <input type="email" id="email" name="email" required
                       class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500"
                       placeholder="reader@example.com">
              </div>
              <div>
                <label for="room_number" class="block text-sm font-medium text-gray-700 mb-1">Room Number</label>
                <!-- DEBUG INFO -->
                <div style="display: none;" class="debug-info">
                  <p>Tournament ID: {{ tournament.id }}</p>
                  <p>Format JSON: {{ tournament.format_json|tojson|safe }}</p>
                  <p>Assigned Rooms: {{ assigned_rooms|tojson|safe }}</p>
                </div>
                <!-- END DEBUG INFO -->
                {% set max_rooms = tournament.get_max_rooms() %}
                <div class="debug-info" style="display: none;">
                  <p>Max Rooms: {{ max_rooms }}</p>
                </div>
                {% if max_rooms > 0 %}
                  <select id="room_number" name="room_number" required
                          class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500">
                    <option value="" disabled selected>Select a room</option>
                    {% for i in range(1, max_rooms + 1) %}
                      {% if not assigned_rooms or i not in assigned_rooms %}
                        {% set room_name = room_aliases.get(i, 'Room ' ~ i) %}
                        <option value="{{ i }}">{{ room_name }}</option>
                      {% endif %}
                    {% endfor %}
                  </select>
                  {% if assigned_rooms and assigned_rooms|length >= max_rooms %}
                    <p class="text-sm text-red-500 mt-1">All rooms are assigned. Please remove a reader from a room to assign a new one.</p>
                  {% endif %}
                {% else %}
                  <p class="text-sm text-red-500">No rooms available. Please check the tournament format.</p>
                  <div class="debug-info" style="display: block; background: #f0f0f0; padding: 10px; margin-top: 10px; border-radius: 4px;">
                    <p><strong>Debug Info:</strong></p>
                    <p>Max Rooms: {{ max_rooms }}</p>
                    <p>Format JSON: {{ tournament.format_json|tojson|safe }}</p>
                    <p>Assigned Rooms: {{ assigned_rooms|tojson|safe }}</p>
                  </div>
                {% endif %}
              </div>
            </div>
            <div>
              <button type="submit" class="bg-purple-600 text-white px-4 py-2 rounded-md hover:bg-purple-700 transition-colors">
                Assign to Room
              </button>
            </div>
          </form>
          <p class="text-sm text-gray-500 mt-2">
            The reader must have already registered an account with this email.
          </p>
        </div>
        </div>
        </div> <!-- End Reader Management Tab -->

        <!-- Team Management Tab -->
        <div id="teams-tab-content" class="tab-pane hidden">
          <h2 class="text-3xl font-bold mb-4">Team Management</h2>
        
        <!-- Assign Real Team Names Form -->
        <div class="mb-6">
          <h4 class="text-xl font-semibold mb-3">Assign Team Names</h4>
          <form method="POST" class="space-y-4" onsubmit="return validateTeamForm()">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div>
                <label for="team_id" class="block text-sm font-medium text-gray-700">Team ID:</label>
                <select id="team_id" name="team_id" required 
                        class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                  <option value="">Select a team ID</option>
                  {% for team_id in unassigned_teams %}
                    <option value="{{ team_id }}">{{ team_id }}</option>
                  {% endfor %}
                </select>
              </div>
              <div>
                <label for="team_name" class="block text-sm font-medium text-gray-700">Team Name:</label>
                <input type="text" id="team_name" name="team_name" required 
                       class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
              </div>
              <div>
                <label for="players" class="block text-sm font-medium text-gray-700">Players (comma separated):</label>
                <input type="text" id="players" name="players" 
                       class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
              </div>
            </div>
            <div class="text-right">
              <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded">
                Assign Team Name
              </button>
            </div>
          </form>
        </div>
        

        <!-- Assigned Teams -->
        <div>
          <h4 class="text-xl font-semibold mb-3">Assigned Teams</h4>
          {% if assigned_teams %}
            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
              {% for team_id, team_data in assigned_teams.items() %}
                <div class="border border-gray-200 rounded-lg p-3 hover:bg-gray-50 relative" id="team-{{ team_id }}">
                  <div class="flex justify-between items-start">
                    <div>
                      <div class="font-medium text-gray-900">{{ team_id }}</div>
                      <div class="text-sm text-gray-600">{{ team_data.name }}</div>
                    </div>
                    <button type="button" 
                            onclick="confirmDeleteTeam('{{ team_id }}')"
                            class="text-red-500 hover:text-red-700">
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                      </svg>
                    </button>
                  </div>
                  <div class="mt-2 pt-2 border-t border-gray-100">
                    <div class="flex justify-between items-center mb-1">
                      <div class="text-xs font-medium text-gray-500">Players:</div>
                      <button type="button" 
                              onclick="openEditPlayersModal('{{ team_id }}', '{{ team_data.name }}')"
                              class="text-xs text-blue-600 hover:text-blue-800">
                        Edit Players
                      </button>
                    </div>
                    {% if team_data.players %}
                      <ul class="text-xs text-gray-600" id="players-{{ team_id }}">
                        {% for player in team_data.players %}
                          <li class="truncate">{{ player }}</li>
                        {% endfor %}
                      </ul>
                    {% else %}
                      <p id="players-{{ team_id }}" class="text-xs text-gray-400 italic">No players added yet</p>
                    {% endif %}
                  </div>
                </div>
              {% endfor %}
            </div>
          {% else %}
            <p class="text-gray-500 italic">No teams assigned yet.</p>
          {% endif %}
        </div>
        </div>

        <!-- Tournament Stages Tab -->
        <div id="stages-tab-content" class="tab-pane hidden">
          <h2 class="text-3xl font-bold mb-4">Tournament Stages</h2>
          <div class="grid grid-cols-1 gap-6">
            {% for stage in format_data.tournament_format.stages %}
              {% set stage_completed = stage.stage_id|string in completed_stages %}
              <div class="bg-white rounded-lg shadow-md p-6 border-l-4 {% if stage_completed %}border-green-500{% else %}border-gray-300{% endif %}">
                <div class="flex justify-between items-center mb-4">
                  <h4 class="text-xl font-semibold">
                    {{ stage.stage_name|replace('Winners Bracket - ', '')|replace('Losers Bracket - ', '') }}
                    {% if stage_completed %}
                      <span class="ml-2 text-sm bg-green-100 text-green-800 px-2 py-1 rounded-full">Completed</span>
                    {% endif %}
                  </h4>
                  {% if loop.previtem %}
                    {% set prev_stage_completed = loop.previtem.stage_id|string in completed_stages %}
                    {% set can_proceed = prev_stage_completed or loop.first %}
                  {% else %}
                    {% set can_proceed = True %}
                  {% endif %}
                  
                  {% if stage_completed %}
                    <span class="px-4 py-2 bg-green-100 text-green-800 rounded-md">
                      Stage Completed
                    </span>
                  {% else %}
                    <a href="{{ url_for('admin.create_games', tournament_id=tournament.id, stage_id=stage.stage_id) }}" 
                       class="px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-md {% if not can_proceed %}opacity-50 cursor-not-allowed" disabled{% else %}"{% endif %}
                       {% if not can_proceed %}title="Complete previous stage first"{% endif %}>
                      {% if stage.stage_id == 1 %}
                        Create {{ stage.stage_name }} Games
                      {% else %}
                        Create {{ stage.stage_name }}
                      {% endif %}
                    </a>
                  {% endif %}
                </div>
                
                <!-- Stage Description -->
                <p class="text-gray-600 mb-4">
                  {{ stage.rounds|length }} rounds in this stage
                </p>
                
                <!-- Stage Seeding -->
                <div class="mt-4 pt-4 border-t border-gray-200">
                  <div class="mb-4">
                    <h5 class="font-medium mb-2">
                      {% if stage.stage_id == 1 %}
                        Preliminary Seeding
                      {% else %}
                        {{ stage.stage_name }} Seeding
                      {% endif %}
                    </h5>
                    <div class="mb-4">
                      <button type="button" 
                              onclick="document.getElementById('manual-seeding-{{ stage.stage_id }}').classList.toggle('hidden')"
                              class="bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded">
                        {% if stage.stage_id == 1 %}
                          Manual Seeding
                        {% else %}
                          Configure {{ stage.stage_name }} Teams
                        {% endif %}
                      </button>
                    </div>
                    
                    <!-- Manual Seeding Form -->
                    <div id="manual-seeding-{{ stage.stage_id }}" class="hidden mt-4 p-4 bg-gray-50 rounded-md">
                      <h6 class="font-medium mb-2">
                        {% if stage.stage_id == 1 %}
                          Assign Teams to Preliminary Groups
                        {% else %}
                          Assign Teams to {{ stage.stage_name }} Seeds
                        {% endif %}
                      </h6>
                      
                      <!-- Show current seedings if they exist -->
                      {% set current_seedings = stage_seeded_teams.get(stage.stage_id, {}) %}
                      
                      {% if current_seedings %}
                        <div class="mb-4 p-3 bg-blue-50 rounded border border-blue-100">
                          <h6 class="font-medium text-blue-800 mb-2">Current Seeding:</h6>
                          <ul class="space-y-1">
                            {% for placeholder, team in current_seedings.items() %}
                              <li class="text-sm"><span class="font-medium">{{ placeholder }}:</span> {{ team.name }} ({{ team.id }})</li>
                            {% endfor %}
                          </ul>
                        </div>
                      {% endif %}
                      
                      <form method="POST" action="{{ url_for('admin.manual_seed_teams', tournament_id=tournament.id, stage_id=stage.stage_id) }}" class="space-y-3">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        {% set placeholders = stage_placeholders.get(stage.stage_id, []) %}
                        {% set current_seedings = stage_seeded_teams.get(stage.stage_id, {}) %}
                        
                        {% for placeholder in placeholders %}
                          {% set current_team = current_seedings.get(placeholder, {}) %}
                          <div class="flex items-center space-x-2">
                            <span class="w-8 font-medium">{{ placeholder }}:</span>
                            <select name="team_{{ placeholder }}" class="flex-1 border rounded p-1" required>
                              <option value="">-- Select Team --</option>
                              {% for team_id, team_data in assigned_teams.items() %}
                                <option value="{{ team_id }}" 
                                        {% if current_team and current_team.id == team_id %}selected{% endif %}
                                        data-players="{{ team_data.players|join(', ') }}">
                                  {{ team_data.name }}{% if team_data.players %} ({{ team_data.players|length }} players){% endif %}
                                </option>
                              {% endfor %}
                            </select>
                            <div id="players-{{ placeholder }}" class="text-xs text-gray-600 mt-1 hidden">
                              <div class="font-medium">Players:</div>
                              <div class="players-list"></div>
                            </div>
                            <script>
                              // Show players when a team is selected
                              document.querySelector('select[name="team_{{ placeholder }}"]').addEventListener('change', function(e) {
                                const playersDiv = document.getElementById('players-{{ placeholder }}');
                                const playersList = playersDiv.querySelector('.players-list');
                                const selectedOption = this.options[this.selectedIndex];
                                
                                if (selectedOption.value) {
                                  const players = selectedOption.dataset.players;
                                  if (players) {
                                    playersList.textContent = players;
                                    playersDiv.classList.remove('hidden');
                                  } else {
                                    playersDiv.classList.add('hidden');
                                  }
                                } else {
                                  playersDiv.classList.add('hidden');
                                }
                              });
                              
                              // Trigger change on page load if a team is selected
                              document.addEventListener('DOMContentLoaded', function() {
                                const select = document.querySelector('select[name="team_{{ placeholder }}"]');
                                if (select.value) {
                                  select.dispatchEvent(new Event('change'));
                                }
                              });
                            </script>
                          </div>
                        {% endfor %}
                        {% if placeholders %}
                          <div class="mt-3 flex justify-between">
                            <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded">
                              Save Seeding
                            </button>
                            {% if stage.stage_id > 1 %}
                              <a href="{{ url_for('admin.auto_assign_playoff', tournament_id=tournament.id) }}" 
                                 class="bg-green-500 hover:bg-green-600 text-white py-2 px-4 rounded">
                                Auto-Assign Based on Previous Stage
                              </a>
                            {% endif %}
                          </div>
                        {% else %}
                          <p class="text-gray-500 text-sm">No seeding required for this stage.</p>
                        {% endif %}
                      </form>
                    </div>
                  </div>
                </div>
              </div>
            {% endfor %}
          </div>
        </div>

        <!-- Packets Tab -->
        <div id="packets-tab-content" class="tab-pane hidden">
          <h2 class="text-3xl font-bold mb-4">Tournament Packets</h2>
          <div class="bg-white p-6 rounded-lg shadow-md mb-6">
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-2xl font-bold text-gray-800">Round Question Files</h3>
          <div class="w-64">
            <input type="text" id="roundSearch" placeholder="Search rounds..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
          </div>
        </div>
        
        <div id="roundCards" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
          {% for stage in format_data.tournament_format.stages %}
            {% set sorted_rounds = stage.rounds | sort(attribute='round_in_stage') %}
            {% for rnd in sorted_rounds %}
              {% set has_questions = question_counts.get((stage.stage_id, rnd.round_in_stage), 0) > 0 %}
              <div class="round-card border rounded-lg overflow-hidden shadow-sm hover:shadow-md transition-shadow duration-200" 
                   data-round="{{ rnd.round_in_stage }}">
                <div class="p-5">
                  <div class="flex justify-between items-start mb-3">
                    <div>
                      <h4 class="text-lg font-semibold text-gray-800">
                        {{ stage.stage_name }} - Round {{ rnd.round_in_stage }}
                      </h4>
                      <p class="text-sm text-gray-500">
                        Stage {{ stage.stage_id }} • {{ rnd.round_name or '' }}
                        {% set round_key = (stage.stage_id, rnd.round_in_stage) %}
                        {% set tossup_count = tossup_counts.get(round_key, 0) %}
                        {% set bonus_count = bonus_counts.get(round_key, 0) %}
                        {% if tossup_count > 0 or bonus_count > 0 %}
                          <span class="text-green-600 ml-2">
                            ({{ tossup_count }} tossups, {{ bonus_count }} bonuses)
                          </span>
                        {% endif %}
                      </p>
                    </div>
                    <!-- <span class="flex-shrink-0 px-2.5 py-0.5 rounded-full text-xs font-medium {% if has_questions %}bg-green-100 text-green-800{% else %}bg-gray-100 text-gray-800{% endif %}">
                      {{ 'Uploaded' if has_questions else 'Pending' }}
                    </span> -->
                  </div>
                  
                  <div class="mt-4">
                    {% if has_questions %}
                      <div class="flex items-center justify-between bg-green-50 p-3 rounded-md">
                        <span class="text-sm text-green-700">
                          <i class="fas fa-check-circle mr-1"></i> Questions uploaded
                        </span>
                        <a href="{{ url_for('admin.upload_round_file', tournament_id=tournament.id, stage_id=stage.stage_id, round_number=rnd.round_in_stage) }}" 
                           class="text-blue-600 hover:text-blue-800 text-sm font-medium flex items-center">
                          <i class="fas fa-upload mr-1"></i> Re-upload
                        </a>
                      </div>
                    {% else %}
                      <a href="{{ url_for('admin.upload_round_file', tournament_id=tournament.id, stage_id=stage.stage_id, round_number=rnd.round_in_stage) }}" 
                         class="w-full inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        <i class="fas fa-upload mr-2"></i> Upload Questions
                      </a>
                    {% endif %}
                  </div>
                </div>
              </div>
            {% endfor %}
          {% endfor %}
        </div>
      </div>
          </div>
        </div>

        <!-- Protests Tab -->
        <div id="protests-tab-content" class="tab-pane hidden">
          <h2 class="text-3xl font-bold mb-4">Cycle Protests</h2>
          <div class="mb-8" id="protests-container">
            <div class="bg-white shadow overflow-hidden sm:rounded-lg">
              <div class="px-4 py-5 sm:px-6 border-b border-gray-200">
                <div class="flex justify-between items-center">
                  <h3 class="text-lg leading-6 font-medium text-gray-900">Cycle Protests</h3>
                  <button id="refreshProtestsBtn" class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                    <i class="bi bi-arrow-clockwise"></i> Refresh
                  </button>
                </div>
              </div>
              <div class="bg-white overflow-hidden">
                <div id="protests-list" class="divide-y divide-gray-200">
                  <!-- Protests will be loaded here by JavaScript -->
                  <div class="p-4 text-center text-gray-500">Loading protests...</div>
                </div>
              </div>
            </div>
          </div>
        </div>

      </div> <!-- End Tab Content -->
    </div>
  </main>

  <!-- Edit Players Modal -->
  <div id="editPlayersModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-medium">Edit Players - <span id="teamNameDisplay"></span></h3>
        <button onclick="closeEditPlayersModal()" class="text-gray-400 hover:text-gray-500">
          <span class="sr-only">Close</span>
          <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
      
      <!-- Current Players List -->
      <div class="mb-4">
        <h4 class="text-sm font-medium text-gray-700 mb-2">Current Players</h4>
        <div id="currentPlayersList" class="space-y-2 mb-4">
          <!-- Players will be added here dynamically -->
        </div>
      </div>
      
      <!-- Add New Player Form -->
      <div class="border-t pt-4">
        <h4 class="text-sm font-medium text-gray-700 mb-2">Add New Player</h4>
        <form id="addPlayerForm" class="flex space-x-2">
          <input type="hidden" id="teamId" name="team_id">
          <div class="flex-grow">
            <input type="text" id="playerName" name="player_name" required placeholder="Player name"
                   class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
          </div>
          <button type="submit" 
                  class="px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
            Add
          </button>
        </form>
      </div>
      
      <div class="mt-4 pt-4 border-t flex justify-end">
        <button onclick="closeEditPlayersModal()" 
                class="px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
          Done
        </button>
      </div>
    </div>
  </div>

  <!-- Footer -->
    <footer class="bg-gray-900 text-gray-300 py-8 mt-auto">
      <div class="container mx-auto px-4 text-center">
        <p>© 2025 LIQBA - All rights reserved</p>
        <p class="text-sm text-gray-500 mt-2">Made with ❤️ by Madhavendra Thakur</p>
      </div>
    </footer>
  
  <script>
    // Alerts functionality
    document.addEventListener('DOMContentLoaded', function() {
      // Initialize alerts when the page loads
      initAlerts();
      
      // Set up refresh button
      const refreshBtn = document.getElementById('refreshAlertsBtn');
      if (refreshBtn) {
        refreshBtn.addEventListener('click', fetchAlerts);
      }
      
      // Refresh alerts every 30 seconds
      setInterval(fetchAlerts, 30000);
    });
    
    // Initialize alerts functionality
    function initAlerts() {
      // Fetch alerts immediately when the page loads
      fetchAlerts();
    }
    
    // Fetch alerts from the server
    async function fetchAlerts() {
      try {
        // Get the tournament ID from the URL
        const tournamentId = window.location.pathname.split('/').pop();
        console.log('Fetching alerts for tournament:', tournamentId);
        
        // Include tournament_id in the request
        const response = await fetch(`/admin/alerts?tournament_id=${tournamentId}`);
        
        // Log response status and headers
        console.log('Response status:', response.status, response.statusText);
        console.log('Response headers:');
        for (const [key, value] of response.headers.entries()) {
          console.log(`  ${key}: ${value}`);
        }
        
        // Get response as text first to see what we're getting
        const responseText = await response.text();
        console.log('Raw response:', responseText);
        
        if (!response.ok) {
          throw new Error(`Failed to fetch alerts: ${response.status} ${response.statusText}`);
        }
        
        // If we got here, try to parse as JSON
        try {
          const alerts = JSON.parse(responseText);
          console.log('Parsed alerts:', alerts);
          displayAlerts(alerts);
        } catch (jsonError) {
          console.error('Error parsing JSON:', jsonError);
          throw new Error('Invalid JSON response from server');
        }
      } catch (error) {
        console.error('Error in fetchAlerts:', error);
        const alertsList = document.getElementById('alerts-list');
        if (alertsList) {
          alertsList.innerHTML = `
            <div class="p-4 text-center text-red-600">
              Error loading alerts: ${error.message || 'Unknown error'}. 
              <button onclick="fetchAlerts()" class="text-blue-600 hover:underline">Retry</button>
            </div>`;
        }
      }
    }
    
    // Display alerts in the UI
    function displayAlerts(response) {
      const alertsList = document.getElementById('alerts-list');
      if (!alertsList) return;
      
      // Check if we have a valid response with alerts array
      if (!response || !response.success || !Array.isArray(response.alerts) || response.alerts.length === 0) {
        alertsList.innerHTML = '<div class="p-4 text-center text-gray-500">No active alerts</div>';
        return;
      }
      
      // Map through the alerts array from the response
      alertsList.innerHTML = response.alerts.map(alert => {
        const timeAgo = formatTimeAgo(new Date(alert.created_at));
        const alertClass = alert.level === 'EMERGENCY' ? 'bg-red-50 border-red-200' : 'bg-yellow-50 border-yellow-200';
        const alertIcon = alert.level === 'EMERGENCY' ? 'exclamation-triangle-fill' : 'exclamation-triangle';
        
        return `
          <div class="p-4 border-b ${alertClass}">
            <div class="flex justify-between items-start">
              <div class="flex-1">
                <div class="flex items-center">
                  <i class="bi bi-${alertIcon} mr-2 text-${alert.level === 'EMERGENCY' ? 'red' : 'yellow'}-500"></i>
                  <span class="font-medium">${alert.room} - ${alert.level.replace('_', ' ')}</span>
                </div>
                ${alert.message ? `<p class="mt-1 text-sm text-gray-700">${alert.message}</p>` : ''}
                <p class="text-xs text-gray-500 mt-2">${timeAgo}</p>
              </div>
              <button onclick="resolveAlert(${alert.id})" 
                      class="ml-4 px-3 py-1 bg-white border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50">
                Resolve
              </button>
            </div>
          </div>`;
      }).join('');
    }
    
    // Resolve an alert
    async function resolveAlert(alertId) {
      try {
        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
        const response = await fetch(`/admin/alerts/${alertId}/resolve`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
          }
        });
        
        if (!response.ok) {
          throw new Error('Failed to resolve alert');
        }
        
        // Refresh the alerts list
        fetchAlerts();
      } catch (error) {
        console.error('Error resolving alert:', error);
        alert('Failed to resolve alert. Please try again.');
      }
    }
    
    // Format time ago (e.g., "2 minutes ago")
    function formatTimeAgo(date) {
      const seconds = Math.floor((new Date() - date) / 1000);
      
      const intervals = {
        year: 31536000,
        month: 2592000,
        week: 604800,
        day: 86400,
        hour: 3600,
        minute: 60,
        second: 1
      };
      
      for (const [unit, secondsInUnit] of Object.entries(intervals)) {
        const interval = Math.floor(seconds / secondsInUnit);
        if (interval >= 1) {
          return `${interval} ${unit}${interval === 1 ? '' : 's'} ago`;
        }
      }
      
      return 'just now';
    }
  </script>
  <style>
    /* Ensure consistent styling for all stage cards */
    .stage-card {
      width: 100%;
      margin-bottom: 1.5rem;
    }
    
    /* Fix for any floating elements */
    .clearfix::after {
      content: "";
      display: table;
      clear: both;
    }
  </style>
  <script>
    // Tab functionality
    function showTab(tabName) {
      // Hide all tab contents
      document.querySelectorAll('.tab-pane').forEach(tab => {
        tab.classList.add('hidden');
      });
      
      // Deactivate all tab buttons
      document.querySelectorAll('.tab-button').forEach(button => {
        button.classList.remove('border-blue-500', 'text-blue-600');
        button.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
      });
      
      // Show the selected tab content
      const tabContent = document.getElementById(`${tabName}-tab-content`);
      if (tabContent) {
        tabContent.classList.remove('hidden');
      }
      
      // Activate the selected tab button
      const tabButton = document.getElementById(`${tabName}-tab`);
      if (tabButton) {
        tabButton.classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
        tabButton.classList.add('border-blue-500', 'text-blue-600');
        
        // Save the active tab to localStorage
        saveActiveTab(tabName);
      }
      
      // Special handling for protests tab
      if (tabName === 'protests') {
        fetchProtests();
      }
      
      // If it's the alerts tab, refresh the alerts
      if (tabName === 'overview') {
        fetchAlerts();
      }
    }
    
    // Function to save active tab to localStorage
    function saveActiveTab(tabName) {
      localStorage.setItem('tournamentDetailsActiveTab', tabName);
    }
    
    // Function to get saved tab from localStorage
    function getSavedTab() {
      return localStorage.getItem('tournamentDetailsActiveTab') || 'overview';
    }
    
    // Show saved tab or default to overview
    document.addEventListener('DOMContentLoaded', function() {
      // Show the saved tab or default to 'overview'
      const savedTab = getSavedTab();
      showTab(savedTab);
      
      // Set up periodic refresh of alerts
      setInterval(fetchAlerts, 30000); // Refresh every 30 seconds
      
      // Initial fetch of protests
      fetchProtests();
    });
    
    // Fetch protests from the server
    function fetchProtests() {
      const protestsList = document.getElementById('protests-list');
      protestsList.innerHTML = '<div class="p-4 text-center text-gray-500">Loading protests...</div>';
      
      fetch(`/api/tournaments/{{ tournament.id }}/protests`)
        .then(response => {
          if (!response.ok) {
            throw new Error('Failed to fetch protests');
          }
          return response.json();
        })
        .then(protests => {
          if (protests.error) {
            throw new Error(protests.error);
          }
          
          if (protests.length === 0) {
            protestsList.innerHTML = '<div class="p-4 text-center text-gray-500">No active protests</div>';
            return;
          }
          
          protestsList.innerHTML = '';
          protests.forEach(protest => {
            const protestEl = createProtestElement(protest);
            protestsList.appendChild(protestEl);
          });
        })
        .catch(error => {
          console.error('Error fetching protests:', error);
          protestsList.innerHTML = `
            <div class="p-4 text-center text-red-500">
              Error loading protests: ${error.message}
              <button onclick="fetchProtests()" class="ml-2 text-blue-600 hover:underline">
                Retry
              </button>
            </div>`;
        });
    }
    
    // Create a protest element
    function createProtestElement(protest) {
      const statusColors = {
        'pending': 'bg-yellow-100 text-yellow-800',
        'resolved': 'bg-green-100 text-green-800',
        'rejected': 'bg-red-100 text-red-800'
      };
      
      const statusText = {
        'pending': 'Pending',
        'resolved': 'Resolved',
        'rejected': 'Rejected'
      };
      
      const statusBadge = `<span class="px-2 py-1 text-xs font-medium rounded-full ${statusColors[protest.status] || 'bg-gray-100 text-gray-800'}">
        ${statusText[protest.status] || protest.status}
      </span>`;
      
      // Only show resolve button for pending protests
      const resolveButton = protest.status === 'pending' ? `
        <div class="mt-2">
          <button onclick="event.stopPropagation(); updateProtestStatus(${protest.id}, 'resolved')" 
                  class="w-full px-3 py-1 text-sm bg-blue-100 text-blue-700 rounded hover:bg-blue-200">
            Mark as Resolved
          </button>
        </div>
      ` : '';
      
      const resolutionInfo = protest.status !== 'pending' ? `
        <div class="mt-2 p-2 bg-gray-50 rounded text-sm">
          <p><strong>Resolved by:</strong> ${protest.resolved_by || 'N/A'}</p>
          <p><strong>Resolved at:</strong> ${new Date(protest.resolved_at).toLocaleString()}</p>
          ${protest.resolution_notes ? `<p class="mt-1"><strong>Notes:</strong> ${protest.resolution_notes}</p>` : ''}
        </div>
      ` : '';
      
      const protestEl = document.createElement('div');
      protestEl.className = 'p-4 border-b border-gray-100 cursor-pointer hover:bg-gray-50';
      protestEl.innerHTML = `
        <div class="flex justify-between items-start">
          <div class="flex-1">
            <div class="flex items-center gap-2">
              <span class="font-medium">Round ${protest.round_number}</span>
              <span class="text-gray-400">•</span>
              <span class="text-sm text-gray-600">Game #${protest.game_id}</span>
            </div>
            <div class="mt-1 text-sm text-gray-600">
              <p class="font-medium">${protest.message}</p>
              <div class="mt-1 text-xs text-gray-500">
                <span>Cycle ${protest.cycle_number}</span>
                <span class="mx-1">•</span>
                <span>Submitted by ${protest.created_by} on ${new Date(protest.created_at).toLocaleString()}</span>
              </div>
            </div>
            ${resolutionInfo}
            ${resolveButton}
          </div>
          <div class="ml-4">
            ${statusBadge}
          </div>
        </div>
      `;
      
      return protestEl;
    }
    
    // Update protest status
    function updateProtestStatus(protestId, status) {
      // Optional: Ask for resolution notes
      const resolutionNotes = prompt('Enter resolution notes (optional):');
      
      // Show loading state
      const button = event.target;
      const originalText = button.textContent;
      button.disabled = true;
      button.textContent = 'Resolving...';
      button.classList.add('opacity-50');
      
      fetch(`/api/protests/${protestId}/resolve`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
        },
        body: JSON.stringify({
          resolution_notes: resolutionNotes
        })
      })
      .then(response => {
        if (!response.ok) {
          return response.json().then(err => {
            throw new Error(err.error || 'Failed to update protest');
          });
        }
        return response.json();
      })
      .then(data => {
        // Show success message
        const successMsg = document.createElement('div');
        successMsg.className = 'mt-2 p-2 bg-green-100 text-green-700 rounded text-sm';
        successMsg.textContent = 'Protest resolved successfully';
        
        const container = button.closest('.flex-1');
        container.appendChild(successMsg);
        
        // Remove the button
        button.remove();
        
        // Refresh the protests list after a short delay
        setTimeout(fetchProtests, 1000);
      })
      .catch(error => {
        console.error('Error updating protest status:', error);
        
        // Show error message
        const errorMsg = document.createElement('div');
        errorMsg.className = 'mt-2 p-2 bg-red-100 text-red-700 rounded text-sm';
        errorMsg.textContent = error.message || 'Failed to resolve protest';
        
        const container = button.closest('.flex-1');
        container.appendChild(errorMsg);
        
        // Reset button state
        button.disabled = false;
        button.textContent = originalText;
        button.classList.remove('opacity-50');
      });
    }
  </script>
  <script>
    // Enhanced JavaScript to filter round cards with better search
    document.getElementById('roundSearch').addEventListener('input', function() {
      const searchVal = this.value.trim().toLowerCase();
      const cards = document.querySelectorAll('.round-card');
      
      if (searchVal === '') {
        cards.forEach(card => card.style.display = 'block');
        return;
      }
      
      cards.forEach(card => {
        const cardText = card.textContent.toLowerCase();
        card.style.display = cardText.includes(searchVal) ? 'block' : 'none';
      });
    });
  </script>
  <script>
    // Get the tournament ID from the template
    let currentTournamentId = parseInt('{{ tournament.id }}', 10);
    
    // Confirm before deleting a team
    async function confirmDeleteTeam(teamId) {
      if (confirm(`Are you sure you want to delete team ${teamId}? This action cannot be undone.`)) {
        await deleteTeam(teamId);
      }
    }
    
    // Delete team via API
    async function deleteTeam(teamId) {
      try {
        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
        const response = await fetch(`/admin/api/teams/${currentTournamentId}/delete/${teamId}`, {
          method: 'DELETE',
          headers: {
            'X-CSRFToken': csrfToken,
            'Content-Type': 'application/json'
          },
          credentials: 'same-origin'
        });
        
        const data = await response.json();
        
        if (data.success) {
          // Remove the team card from the UI
          const teamElement = document.getElementById(`team-${teamId}`);
          if (teamElement) {
            teamElement.remove();
          }
          // Show success message
          alert(`Team ${teamId} has been deleted successfully.`);
        } else {
          throw new Error(data.message || 'Failed to delete team');
        }
      } catch (error) {
        console.error('Error deleting team:', error);
        alert(`Error: ${error.message}`);
      }
    }
    let currentTeamId = '';
    let currentTeamName = '';

    // Validate team creation form
    function validateTeamForm() {
      const playersInput = document.getElementById('players');
      const players = playersInput.value.trim();
      
      if (!players) {
        alert('Please enter at least one player for the team.');
        playersInput.focus();
        return false;
      }
      
      // Ensure there's at least one non-empty player name
      const playerNames = players.split(',').map(name => name.trim()).filter(name => name.length > 0);
      if (playerNames.length === 0) {
        alert('Please enter at least one valid player name.');
        playersInput.focus();
        return false;
      }
      
      return true;
    }

    function openEditPlayersModal(teamId, teamName) {
      currentTeamId = teamId;
      document.getElementById('teamId').value = teamId;
      document.getElementById('teamNameDisplay').textContent = teamName;
      
      // Load current players
      fetch(`/admin/api/teams/{{ tournament.id }}/players?team_id=${teamId}`, {
        headers: {
          'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
        }
      })
      .then(response => response.json())
      .then(data => {
        const playersList = document.getElementById('currentPlayersList');
        playersList.innerHTML = '';
        
        if (data.players && data.players.length > 0) {
          data.players.forEach(player => {
            const playerElement = document.createElement('div');
            playerElement.className = 'flex justify-between items-center p-2 bg-gray-50 rounded-md';
            playerElement.innerHTML = `
              <span>${player.name}</span>
              <button onclick="deletePlayer(${player.id}, '${player.name.replace(/'/g, "\\'")}')" 
                      class="text-red-500 hover:text-red-700">
                <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                </svg>
              </button>
            `;
            playersList.appendChild(playerElement);
          });
        } else {
          playersList.innerHTML = '<p class="text-sm text-gray-500">No players yet</p>';
        }
        
        document.getElementById('editPlayersModal').classList.remove('hidden');
        document.getElementById('playerName').focus();
      })
      .catch(error => {
        console.error('Error loading players:', error);
        alert('Failed to load players. Please try again.');
      });
    }
    
    // Close the edit players modal
    function closeEditPlayersModal() {
      document.getElementById('editPlayersModal').classList.add('hidden');
      document.getElementById('addPlayerForm').reset();
    }

    document.getElementById('addPlayerForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const formData = {
        team_id: document.getElementById('teamId').value,
        player_name: document.getElementById('playerName').value
      };

      const errorElement = document.getElementById('playerError');
      errorElement.classList.add('hidden');

      try {
        // Get CSRF token from meta tag
        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
        
        const response = await fetch(`/admin/api/teams/${currentTournamentId}/add_player`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
          },
          body: JSON.stringify(formData),
          credentials: 'same-origin'
        });

        const data = await response.json();

        if (data.success) {
          // Update the player list
          const playerList = document.getElementById(`players-${currentTeamId}`);
          
          // Create new list item for the player
          const playerItem = document.createElement('li');
          playerItem.className = 'truncate';
          playerItem.textContent = formData.player_name;
          
          // If the "No players" message exists, remove it
          if (playerList.tagName === 'P') {
            const newList = document.createElement('ul');
            newList.className = 'text-xs text-gray-600';
            newList.id = `players-${currentTeamId}`;
            playerList.parentNode.replaceChild(newList, playerList);
            newList.appendChild(playerItem);
          } else {
            playerList.appendChild(playerItem);
          }
          
          // Close the modal
          closeAddPlayerModal();
        } else {
          // Show error message
          errorElement.textContent = data.message || 'Failed to add player';
          errorElement.classList.remove('hidden');
        }
      } catch (error) {
        console.error('Error adding player:', error);
        errorElement.textContent = 'An error occurred while adding the player';
        errorElement.classList.remove('hidden');
      }
    });

    // Close modal when clicking outside
    window.onclick = function(event) {
      const modal = document.getElementById('addPlayerModal');
      if (event.target === modal) {
        closeAddPlayerModal();
      }
    };
  </script>
</body>
</html>
