{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Tournament: {{ tournament.name }}</h2>
        <div>
            <a href="{{ url_for('reader.dashboard') }}" class="btn btn-outline-secondary me-2">Back to Dashboard</a>
            <a href="{{ url_for('reader.logout') }}" class="btn btn-outline-danger">Logout</a>
        </div>
    </div>
    
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }}">{{ message }}</div>
            {% endfor %}
        {% endif %}
    {% endwith %}
    
    <div class="card mb-4">
        <div class="card-header">
            <h4 class="mb-0">Tournament Information</h4>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-4">
                    <p><strong>Tournament:</strong> {{ tournament.name }}</p>
                    <p><strong>Date:</strong> {{ tournament.date.strftime('%B %d, %Y') }}</p>
                    <p><strong>Location:</strong> {{ tournament.location or 'N/A' }}</p>
                </div>
                <div class="col-md-4">
                    <p><strong>Status:</strong> {{ tournament.status|title }}</p>
                    <p><strong>Your Room:</strong> {{ room_display_name }}</p>
                    <p><strong>Your Games:</strong> {{ games|length }}</p>
                </div>
                <div class="col-md-4">
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i>
                        You are assigned to <strong>{{ room_display_name }}</strong>. 
                        You can only view and score games in this room.
                    </div>
                </div>
            </div>
        </div>
    </div>
  
    <!-- Search and Filter -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row">
                <div class="col-md-6 mb-3 mb-md-0">
                    <label for="roundSearch" class="form-label">Search by Round</label>
                    <input type="text" id="roundSearch" class="form-control" placeholder="Enter round number...">
                </div>
                <div class="col-md-6">
                    <label for="teamSearch" class="form-label">Search by Team</label>
                    <input type="text" id="teamSearch" class="form-control" placeholder="Enter team name...">
                </div>
            </div>
        </div>
    </div>
    <!-- Group games by stage and round -->
    {% set stage_groups = {} %}
    {% for game in games %}
      {% set stage_id = game.stage_id|default(1) %}
      {% set stage_name = 'Prelims' if stage_id == 1 else ('Playoffs' if stage_id == 2 else 'Stage ' ~ stage_id) %}
      {% set stage_round = (stage_id, game.round_number) %}
      {% if stage_round not in stage_groups %}
        {% set _ = stage_groups.update({stage_round: {'stage_name': stage_name, 'games': []}}) %}
      {% endif %}
      {% set _ = stage_groups[stage_round]['games'].append(game) %}
    {% endfor %}
    
    <!-- Games List -->
    <div class="card">
        <div class="card-header">
            <h4 class="mb-0">Games</h4>
        </div>
        <div class="card-body">
            {% set stage_groups = {} %}
            {% for game in games %}
                {% set stage_id = game.stage_id|default(1) %}
                {% set stage_name = 'Prelims' if stage_id == 1 else ('Playoffs' if stage_id == 2 else 'Stage ' ~ stage_id) %}
                {% set stage_round = (stage_id, game.round_number) %}
                {% if stage_round not in stage_groups %}
                    {% set _ = stage_groups.update({stage_round: {'stage_name': stage_name, 'games': []}}) %}
                {% endif %}
                {% set _ = stage_groups[stage_round]['games'].append(game) %}
            {% endfor %}
            
            {% for (stage_id, round_num), group in stage_groups|dictsort %}
                <div class="round-group mb-4" data-stage="{{ stage_id }}" data-round="{{ round_num }}">
                    <h5 class="fw-bold mb-2">{{ group.stage_name }} - Round {{ round_num }}</h5>
                    <div class="row g-3 mb-4">
                        {% for game in group.games %}
                            <div class="col-md-6">
                                <div class="game-card card h-100" 
                                     data-round="{{ game.round_number }}" 
                                     data-stage="{{ game.stage_id }}"
                                     data-team="{{ (game.team1 ~ ' ' ~ game.team2)|lower }}">
                                    <div class="card-body">
                                        <div class="flex justify-between items-start mb-2">
                                            <h6 class="card-title mb-0">
                                                <span class="{% if game.team1_pending %}text-primary{% endif %}">
                                                    {{ game.team1 }}
                                                    {% if game.team1_pending and game.team1_info %}
                                                        <span class="text-sm font-normal text-gray-500 ml-1">(pending)</span>
                                                    {% endif %}
                                                </span>
                                            </h6>
                                            {% if game.room_number %}
                                                <span class="text-sm bg-blue-100 text-blue-800 px-2 py-1 rounded">
                                                    {{ get_room_display_name(tournament.id, game.room_number) }}
                                                </span>
                                            {% endif %}
                                        </div>
                  <span class="mx-2 text-gray-500">vs</span>
                  <span class="{% if game.team2_pending %}text-blue-600{% endif %}">
                    {{ game.team2 }}
                    {% if game.team2_pending and game.team2_info %}
                      <span class="text-sm font-normal text-gray-500 ml-1">(pending)</span>
                    {% endif %}
                  </span>
                </div>
              </h4>
              {% if (game.team1_pending and game.team1_info) or (game.team2_pending and game.team2_info) %}
                <div class="text-sm text-gray-600 mb-2 p-2 bg-gray-100 rounded">
                  {% if game.team1_pending and game.team1_info %}
                    <div class="mb-1">
                      <span class="font-medium">Team 1:</span> Waiting for {{ game.team1_info.team1 }} vs {{ game.team1_info.team2 }}
                      <span class="text-xs text-gray-500">({{ game.team1_info.formatted_ref }})</span>
                    </div>
                  {% endif %}
                  {% if game.team2_pending and game.team2_info %}
                    <div>
                      <span class="font-medium">Team 2:</span> Waiting for {{ game.team2_info.team1 }} vs {{ game.team2_info.team2 }}
                      <span class="text-xs text-gray-500">({{ game.team2_info.formatted_ref }})</span>
                    </div>
                  {% endif %}
                </div>
              {% endif %}
              <p class="mb-2">
                <span class="font-medium">Status:</span>
                {% if game.result is not none and game.result != -2 %}
                  <span class="text-green-600 font-bold">Completed</span>
                {% elif game.scorecard %}
                  <span class="text-yellow-600 font-bold">In Progress</span>
                {% else %}
                  <span class="text-red-600 font-bold">Not Started</span>
                {% endif %}
              </p>
              {% if game.result is not none and game.result != -2 %}
                <button class="w-full bg-gray-400 text-white text-center py-2 rounded cursor-not-allowed" disabled>
                  Game Completed
                </button>
              {% else %}
                <a href="{{ url_for('reader.submit_game', game_id=game.id) }}" class="block bg-blue-500 hover:bg-blue-600 text-white text-center py-2 rounded">
                  {% if game.scorecard %}Edit Score{% else %}Start Game{% endif %}
                </a>
              {% endif %}
            </div>
          {% endfor %}
        </div>
      </div>
    {% endfor %}
  </main>
  <script>
    // Filter function combining round, stage, and team queries
    function filterCards() {
      const roundQuery = document.getElementById('roundSearch').value.trim().toLowerCase();
      const teamQuery = document.getElementById('teamSearch').value.trim().toLowerCase();
      const gameCards = document.querySelectorAll('.game-card');
      let anyVisible = false;

      // First hide all game cards
      gameCards.forEach(card => {
        card.style.display = 'none';
      });

      // Then show matching ones
      gameCards.forEach(card => {
        const round = card.getAttribute('data-round');
        const stage = card.getAttribute('data-stage');
        const teamText = card.getAttribute('data-team').toLowerCase();
        
        const roundMatch = !roundQuery || round.includes(roundQuery);
        const teamMatch = !teamQuery || teamText.includes(teamQuery);
        
        if (roundMatch && teamMatch) {
          card.style.display = 'block';
          anyVisible = true;
        }
      });

      // Show/hide round headers based on visibility of their games
      document.querySelectorAll('.round-group').forEach(group => {
        const hasVisibleGames = Array.from(group.querySelectorAll('.game-card'))
          .some(card => card.style.display !== 'none');
        
        group.style.display = hasVisibleGames ? 'block' : 'none';
      });
    }

    // Add event listeners
    document.getElementById('roundSearch').addEventListener('input', filterCards);
    document.getElementById('teamSearch').addEventListener('input', filterCards);
  </script>
  
  <!-- Footer -->
    <footer class="bg-gray-900 text-gray-300 py-8 mt-auto">
      <div class="container mx-auto px-4 text-center">
        <p>© 2025 LIQBA - All rights reserved</p>
        <p class="text-sm text-gray-500 mt-2">Made with ❤️ by Madhavendra Thakur</p>
      </div>
    </footer>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
// Filter function combining round and team queries
function filterCards() {
    const roundQuery = document.getElementById('roundSearch').value.toLowerCase();
    const teamQuery = document.getElementById('teamSearch').value.toLowerCase();
    
    document.querySelectorAll('.game-card').forEach(card => {
        const round = card.getAttribute('data-round') || '';
        const team = card.getAttribute('data-team') || '';
        const stage = card.getAttribute('data-stage') || '';
        
        const roundMatch = round.includes(roundQuery);
        const teamMatch = team.includes(teamQuery);
        
        if ((!roundQuery || roundMatch) && (!teamQuery || teamMatch)) {
            card.style.display = '';
            // Show the parent round group if any card is visible
            const roundGroup = card.closest('.round-group');
            if (roundGroup) {
                roundGroup.style.display = '';
            }
        } else {
            card.style.display = 'none';
            // Hide the parent round group if all cards are hidden
            const roundGroup = card.closest('.round-group');
            if (roundGroup) {
                const visibleCards = roundGroup.querySelectorAll('.game-card:not([style*="display: none"])');
                if (visibleCards.length === 0) {
                    roundGroup.style.display = 'none';
                }
            }
        }
    });
}

// Add event listeners
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('roundSearch').addEventListener('input', filterCards);
    document.getElementById('teamSearch').addEventListener('input', filterCards);
});
</script>
{% endblock %}
