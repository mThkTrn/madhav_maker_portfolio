{% extends "base.html" %}

{% block title %}Create New Dataset - Forj{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <h1 class="text-3xl font-bold mb-6">Create New Dataset</h1>
    
    <div class="bg-white rounded-lg shadow-md p-6 form-container">
        <form id="datasetForm" class="space-y-6">
            {{ form.hidden_tag() }}
            
            <div>
                <label for="description" class="block text-sm font-medium text-gray-700 mb-1">Dataset Description</label>
                <textarea id="description" name="description" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" rows="3" placeholder="Describe the dataset you want to generate (e.g., 'Customer data for an e-commerce store with purchase history')" required>{{ form.description.data or '' }}</textarea>
                <p class="mt-1 text-sm text-gray-500">Be as specific as possible about the data you need.</p>
            </div>
            
            <div>
                <label for="columns" class="block text-sm font-medium text-gray-700 mb-1">Columns</label>
                <textarea id="columns" name="columns" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" rows="5" placeholder="Enter one column name per line&#10;Example:
first_name
last_name
email
phone
address" required>{{ form.columns.data or '' }}</textarea>
                <p class="mt-1 text-sm text-gray-500">Enter one column name per line. You can add descriptions in parentheses, e.g., "price (in USD)"</p>
            </div>
            
            <div class="w-1/3">
                <label for="row_count" class="block text-sm font-medium text-gray-700 mb-1">Number of Rows</label>
                <input type="number" id="row_count" name="row_count" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" min="1" max="10000" value="{{ form.row_count.data or '100' }}" required>
            </div>
            
            <div class="flex justify-end space-x-3 pt-4">
                <a href="{{ url_for('dashboard') }}" class="px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    Cancel
                </a>
                <button type="submit" class="px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 flex items-center" id="generateButton">
                    <span class="button-text">Generate Sample</span>
                    <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white hidden" id="spinner" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </button>
            </div>
        </form>
    </div>
    
    <!-- Loading State -->
    <div id="loadingSection" class="mt-8 bg-white rounded-lg shadow-md p-6 hidden">
        <div class="flex flex-col items-center justify-center py-8">
            <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500 mb-4"></div>
            <p class="text-lg font-medium text-gray-700">Generating your dataset...</p>
            <p class="text-sm text-gray-500 mt-2">This may take a moment. Please do not close this page.</p>
            <div class="w-full bg-gray-200 rounded-full h-2.5 mt-4 max-w-md">
                <div id="progressBar" class="bg-blue-600 h-2.5 rounded-full transition-all duration-300 ease-in-out" style="width: 0%"></div>
            </div>
            <p id="progressText" class="text-sm text-gray-600 mt-2">Initializing...</p>
            <div id="logContainer" class="mt-4 text-left w-full max-w-2xl h-48 overflow-y-auto bg-gray-50 p-3 rounded-md font-mono text-sm border border-gray-200">
                <!-- Logs will appear here -->
            </div>
        </div>
    </div>
    
    <!-- Feedback Section -->
    <div id="feedbackSection" class="mt-8 bg-white rounded-lg shadow-md p-6 hidden">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-xl font-semibold">Review Samples</h2>
            <span id="feedbackRound" class="px-3 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                Round <span id="currentRound">1</span> of 3
            </span>
        </div>
        
        <div id="samplesContainer" class="space-y-6">
            <!-- Sample cards will be inserted here by JavaScript -->
            <div class="text-center py-8 text-gray-500" id="noSamplesMessage">
                <p>Generating samples for review...</p>
            </div>
        </div>
        
        <div class="mt-8 pt-6 border-t border-gray-200 flex justify-end">
            <button id="submitFeedbackBtn" class="px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                Submit Feedback & Continue
            </button>
        </div>
    </div>
    
    <!-- Results Section -->
    <div class="mt-8 bg-white rounded-lg shadow-md p-6 hidden transition-all duration-300 ease-in-out transform" id="resultSection">
        <h2 class="text-xl font-semibold mb-4">
            Dataset Generation Complete!
        </h2>
        <div class="bg-green-50 border-l-4 border-green-400 p-4 mb-6">
            <div class="flex">
                <div class="flex-shrink-0">
                    <svg class="h-5 w-5 text-green-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                    </svg>
                </div>
                <div class="ml-3">
                    <p class="text-sm text-green-700">
                        Successfully generated <span id="finalRowCount" class="font-medium">0</span> rows of synthetic data.
                    </p>
                </div>
            </div>
        </div>
        
        <!-- Dataset Preview -->
        <div class="mt-6">
            <h3 class="text-lg font-medium text-gray-900 mb-3">Dataset Preview</h3>
            <div id="sampleDataContainer" class="overflow-x-auto">
                <!-- Sample data will be rendered here -->
            </div>
        </div>
        
        <div class="mt-6 flex space-x-3">
            <button type="button" onclick="downloadDataset()" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                <svg class="-ml-1 mr-2 h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                </svg>
                Download Dataset (JSON)
            </button>
            <button type="button" onclick="window.location.reload()" class="inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                <svg class="-ml-1 mr-2 h-5 w-5 text-gray-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd" />
                </svg>
                Start Over
            </button>
        </div>
    </div>
    

</div>

<script>
// Global variables
let currentSessionId = null;
let currentSamples = [];
let feedbackSection = null;
let resultSection = null;
let datasetColumns = []; // Store the column definitions
    
    // Initialize when the DOM is fully loaded
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM fully loaded, initializing...');
        
        try {
            const form = document.getElementById('datasetForm');
            if (!form) console.error('Could not find datasetForm');
            
            const loadingSection = document.getElementById('loadingSection');
            console.log('Loading section found:', !!loadingSection);
            
            feedbackSection = document.getElementById('feedbackSection');
            console.log('Feedback section found:', !!feedbackSection);
            
            resultSection = document.getElementById('resultSection');
            console.log('Result section found:', !!resultSection);
            
            const submitButton = document.querySelector('button[type="submit"]');
            const submitFeedbackBtn = document.getElementById('submitFeedbackBtn');
            const downloadBtn = document.getElementById('downloadBtn');
            
            // Initialize sections with null checks
            const sections = [
                { name: 'loading', el: loadingSection },
                { name: 'feedback', el: feedbackSection },
                { name: 'result', el: resultSection }
            ];
            
            sections.forEach(section => {
                try {
                    console.log(`Initializing ${section.name} section...`);
                    if (section.el) {
                        section.el.classList.add('hidden');
                        console.log(`Successfully initialized ${section.name} section`);
                    } else {
                        console.error(`Could not find ${section.name} section`);
                    }
                } catch (e) {
                    console.error(`Error initializing ${section.name} section:`, e);
                }
            });
        
            // Auto-resize textareas
            console.log('Setting up textarea auto-resize...');
            const textareas = document.querySelectorAll('textarea');
            console.log(`Found ${textareas.length} textareas`);
            textareas.forEach((textarea, index) => {
                try {
                    console.log(`Setting up textarea ${index + 1}`);
                    textarea.addEventListener('input', () => {
                        try {
                            autoResize(textarea);
                        } catch (e) {
                            console.error('Error in textarea input handler:', e);
                        }
                    });
                    // Initial resize
                    autoResize(textarea);
                } catch (e) {
                    console.error(`Error setting up textarea ${index + 1}:`, e);
                }
            });
        
            // Form submission
            console.log('Setting up form submission handler...');
            if (form) {
                form.addEventListener('submit', function(e) {
                    console.log('Form submitted');
                    try {
                        e.preventDefault();
                        console.log('Calling startGeneration...');
                        startGeneration();
                    } catch (e) {
                        console.error('Error in form submission:', e);
                        showError('An error occurred while submitting the form. Please check the console for details.');
                    }
                });
            } else {
                console.error('Could not set up form submission handler: form not found');
            }
        
            // Submit feedback button
            if (submitFeedbackBtn) {
                console.log('Setting up submit feedback button...');
                submitFeedbackBtn.addEventListener('click', function(e) {
                    console.log('Submit feedback clicked');
                    try {
                        submitFeedback(e);
                    } catch (e) {
                        console.error('Error in submitFeedback:', e);
                        showError('An error occurred while submitting feedback. Please check the console for details.');
                    }
                });
            } else {
                console.warn('Submit feedback button not found');
            }
            
            // Download button
            if (downloadBtn) {
                console.log('Setting up download button...');
                downloadBtn.addEventListener('click', function(e) {
                    console.log('Download clicked');
                    try {
                        downloadDataset(e);
                    } catch (e) {
                        console.error('Error in downloadDataset:', e);
                        showError('An error occurred while downloading the dataset. Please check the console for details.');
                    }
                });
            } else {
                console.warn('Download button not found');
            }
        
            // Update progress bar
            function updateProgress(percent, message) {
                try {
                    console.log(`Updating progress: ${percent}% - ${message}`);
                    const progressBar = document.getElementById('progressBar');
                    const progressText = document.getElementById('progressText');
                    
                    if (progressBar) {
                        progressBar.style.width = `${Math.min(100, Math.max(0, percent))}%`;
                    } else {
                        console.error('Progress bar element not found');
                    }
                    
                    if (progressText) {
                        progressText.textContent = message || `Processing... ${Math.round(percent)}%`;
                    } else {
                        console.error('Progress text element not found');
                    }
                } catch (e) {
                    console.error('Error updating progress:', e);
                }
            }
        
            // Toggle loading state
        function setLoading(isLoading) {
            try {
                console.log(`Setting loading state to: ${isLoading}`);
                const generateButton = document.getElementById('generateButton');
                const spinner = document.getElementById('spinner');
                const buttonText = document.querySelector('.button-text');
                
                if (!generateButton) {
                    console.error('Generate button not found');
                    return;
                }
                
                generateButton.disabled = isLoading;
                
                if (buttonText) {
                    buttonText.textContent = isLoading ? 'Generating...' : 'Generate Sample';
                } else {
                    console.error('Button text element not found');
                }
                
                if (spinner) {
                    if (isLoading) {
                        spinner.classList.remove('hidden');
                    } else {
                        spinner.classList.add('hidden');
                    }
                } else {
                    console.error('Spinner element not found');
                }
            } catch (e) {
                console.error('Error in setLoading:', e);
            }
        }
        
        // Log function for displaying messages
        function log(message, type = 'info') {
            try {
                const timestamp = new Date().toLocaleTimeString();
                const logContainer = document.getElementById('logContainer');
                if (!logContainer) {
                    console.warn('Log container not found');
                    return;
                }
                
                const logEntry = document.createElement('div');
                logEntry.className = `log-entry ${type}`;
                logEntry.innerHTML = `<span class="text-gray-500">[${timestamp}]</span> ${message}`;
                logContainer.appendChild(logEntry);
                logContainer.scrollTop = logContainer.scrollHeight;
            } catch (e) {
                console.error('Error in log function:', e);
            }
        }
        
        // Start the dataset generation process
        async function startGeneration() {
            const description = document.getElementById('description').value;
            const columns = document.getElementById('columns').value.split('\n')
                .map(col => col.trim())
                .filter(col => col.length > 0);
            const rowCount = document.getElementById('row_count').value;
            
            if (!description) {
                showError('Please enter a description for your dataset');
                return;
            }
            
            if (columns.length === 0) {
                showError('Please enter at least one column');
                return;
            }
            
            try {
                // Store the column definitions for later use
                datasetColumns = columns;
                
                // Hide the form and show loading state
                const formContainer = document.querySelector('.form-container');
                if (formContainer) {
                    formContainer.classList.add('hidden');
                }
                
                setLoading(true);
                resultSection.classList.add('hidden');
                feedbackSection.classList.add('hidden');
                loadingSection.classList.remove('hidden');
                const logContainer = document.getElementById('logContainer');
                logContainer.innerHTML = ''; // Clear previous logs
                updateProgress(10, 'Starting dataset generation...');
                
                // Start the generation process
                const response = await fetch('/api/start-generation', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token() }}'
                    },
                    body: JSON.stringify({
                        description: description,
                        columns: columns,
                        row_count: rowCount
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error || 'Failed to start dataset generation');
                }
                
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                // Store the session ID
                currentSessionId = data.session_id;
                
                // Display the samples for feedback
                displaySamplesForFeedback(data.samples, data.feedback_round);
                
                // Update UI
                updateProgress(100, 'Samples generated!');
                loadingSection.classList.add('hidden');
                feedbackSection.classList.remove('hidden');
                feedbackSection.scrollIntoView({ behavior: 'smooth' });
                
            } catch (error) {
                console.error('Error:', error);
                log(`Error: ${error.message}`, 'error');
                showError(error.message);
            } finally {
                setLoading(false);
            }
        }
        
        // Display samples for user feedback in a table, one by one
        async function displaySamplesForFeedback(samples, feedbackRound) {
            const samplesContainer = document.getElementById('samplesContainer');
            samplesContainer.innerHTML = '';
            currentSamples = samples;
            
            // Update feedback round
            const currentRoundEl = document.getElementById('currentRound');
            if (currentRoundEl) {
                currentRoundEl.textContent = feedbackRound;
            }
            
            if (!samples || samples.length === 0) {
                const noSamplesMessage = document.getElementById('noSamplesMessage');
                if (noSamplesMessage) {
                    noSamplesMessage.classList.remove('hidden');
                }
                return;
            }
            
            const noSamplesMessage = document.getElementById('noSamplesMessage');
            if (noSamplesMessage) {
                noSamplesMessage.classList.add('hidden');
            }
            
            // Create a progress indicator
            const progressContainer = document.createElement('div');
            progressContainer.className = 'w-full bg-gray-200 rounded-full h-2.5 mb-6';
            const progressBar = document.createElement('div');
            progressBar.className = 'bg-blue-600 h-2.5 rounded-full transition-all duration-500 ease-in-out';
            progressBar.style.width = '0%';
            progressContainer.appendChild(progressBar);
            samplesContainer.appendChild(progressContainer);
            
            // Create a container for the sample tables
            const tablesContainer = document.createElement('div');
            tablesContainer.className = 'space-y-6';
            samplesContainer.appendChild(tablesContainer);
            
            // Get all unique column names from all samples
            const allColumns = new Set();
            samples.forEach(sample => {
                if (sample.data) {
                    Object.keys(sample.data).forEach(key => allColumns.add(key));
                }
            });
            
            // Convert to array and use datasetColumns if available
            const columns = datasetColumns && datasetColumns.length > 0 
                ? datasetColumns.filter(col => allColumns.has(col))
                : Array.from(allColumns);
            
            // Add any remaining columns that weren't in datasetColumns
            allColumns.forEach(col => {
                if (!columns.includes(col)) {
                    columns.push(col);
                }
            });
            
            // Function to create a sample table
            function createSampleTable(sample, index, total) {
                const tableContainer = document.createElement('div');
                tableContainer.className = 'bg-white border border-gray-200 rounded-lg p-6 shadow-lg transform transition-all duration-500 ease-in-out opacity-0 translate-y-6';
                tableContainer.style.display = 'none';
                
                // Create the table
                let tableHtml = `
                    <div class="flex justify-between items-center mb-4">
                        <div class="flex items-center">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                Sample ${index + 1} of ${total}
                            </span>
                        </div>
                        <div class="flex space-x-2">
                            <button data-sample-id="${sample.id}" data-feedback="true" 
                                    class="feedback-btn px-4 py-2 rounded-md text-sm font-medium transition-colors duration-200 ${sample.approved === true ? 'bg-green-100 text-green-800 border-2 border-green-300' : 'bg-white text-gray-600 border border-gray-300 hover:bg-green-50'}">
                                <span class="flex items-center">
                                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                    </svg>
                                    Good
                                </span>
                            </button>
                            <button data-sample-id="${sample.id}" data-feedback="false" 
                                    class="feedback-btn px-4 py-2 rounded-md text-sm font-medium transition-colors duration-200 ${sample.approved === false ? 'bg-red-100 text-red-800 border-2 border-red-300' : 'bg-white text-gray-600 border border-gray-300 hover:bg-red-50'}">
                                <span class="flex items-center">
                                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                    Needs Work
                                </span>
                            </button>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>`;
                
                // Add table headers
                columns.forEach(column => {
                    tableHtml += `
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        ${column}
                                    </th>`;
                });
                
                tableHtml += `
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                <tr>`;
                
                // Add table cells
                columns.forEach(column => {
                    const value = sample.data && sample.data[column] !== undefined ? sample.data[column] : '';
                    tableHtml += `
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                        ${value}
                                    </td>`;
                });
                
                tableHtml += `
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="mt-4">
                        <label for="feedback-${sample.id}" class="block text-sm font-medium text-gray-700 mb-2">Your Feedback (optional)</label>
                        <textarea id="feedback-${sample.id}" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:ring-blue-500 focus:border-blue-500" 
                                placeholder="What would make this sample better?" 
                                rows="2">${sample.feedback || ''}</textarea>
                    </div>`;
                
                tableContainer.innerHTML = tableHtml;
                
                // Add click handlers for feedback buttons
                tableContainer.querySelectorAll('.feedback-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const sampleId = this.getAttribute('data-sample-id');
                        const approved = this.getAttribute('data-feedback') === 'true';
                        handleFeedback(sampleId, approved, this);
                    });
                });
                
                return tableContainer;
            }
            
            // Show samples one by one with animation
            samples.forEach((sample, index) => {
                setTimeout(() => {
                    const table = createSampleTable(sample, index, samples.length);
                    tablesContainer.appendChild(table);
                    table.style.display = 'block';
                    
                    // Trigger animation
                    setTimeout(() => {
                        table.classList.remove('opacity-0', 'translate-y-6');
                    }, 10);
                    
                    // Update progress
                    const progress = ((index + 1) / samples.length) * 100;
                    progressBar.style.width = `${progress}%`;
                    
                    // Scroll to show the new sample if it's not the first one
                    if (index > 0) {
                        table.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    }
                }, index * 300); // 300ms delay between each sample
            });
            
            // Add the feedback handler function
            window.handleFeedback = function(sampleId, approved, button) {
                // Remove active state from all buttons in this card
                const card = button.closest('.bg-white');
                if (card) {
                    card.querySelectorAll('.feedback-btn').forEach(btn => {
                        btn.classList.remove('border-2', 'border-blue-300', 'border-green-300', 'border-red-300');
                        btn.classList.add('border');
                    });
                    
                    // Add active state to clicked button
                    if (approved) {
                        button.classList.remove('bg-white', 'text-gray-600', 'border-gray-300');
                        button.classList.add('bg-green-100', 'text-green-800', 'border-2', 'border-green-300');
                    } else {
                        button.classList.remove('bg-white', 'text-gray-600', 'border-gray-300');
                        button.classList.add('bg-red-100', 'text-red-800', 'border-2', 'border-red-300');
                    }
                }
            };
        }
        
        // Handle feedback for a sample
        function handleFeedback(sampleId, approved, button) {
            console.log('Handling feedback for sample:', sampleId, 'approved:', approved);
            
            // Find the sample in currentSamples
            const sample = currentSamples.find(s => s.id === sampleId);
            if (!sample) {
                console.error('Sample not found:', sampleId);
                return;
            }
            
            // Update the sample's approved status
            sample.approved = approved;
            
            // Update the UI
            const card = button.closest('.bg-white');
            if (!card) {
                console.error('Could not find parent card for button');
                return;
            }
            
            // Remove border-2 and selected styles from all buttons in this card
            const buttons = card.querySelectorAll('.feedback-btn');
            buttons.forEach(btn => {
                btn.classList.remove(
                    'border-2', 
                    'border-green-300', 
                    'border-red-300',
                    'bg-green-100', 
                    'text-green-800', 
                    'bg-red-100', 
                    'text-red-800',
                    'bg-gray-100', 
                    'text-gray-600'
                );
                btn.classList.add('bg-white', 'border', 'border-gray-300');
            });
            
            // Add appropriate styles to the clicked button
            button.classList.remove('bg-white', 'border', 'border-gray-300');
            
            if (approved) {
                button.classList.add('bg-green-100', 'text-green-800', 'border-2', 'border-green-300');
            } else {
                button.classList.add('bg-red-100', 'text-red-800', 'border-2', 'border-red-300');
            }
            
            console.log('Updated button classes:', button.className);
        }
        
        // Submit feedback for all samples
        async function submitFeedback() {
            if (!currentSessionId) {
                showError('No active generation session');
                return;
            }
            
            try {
                setLoading(true);
                log('Submitting feedback and generating next batch...', 'info');
                
                // Collect feedback for all samples
                const feedbackItems = [];
                const sampleCards = document.querySelectorAll('#samplesContainer .bg-white');
                
                sampleCards.forEach((card) => {
                    // Find the selected feedback button (has border-2 class)
                    const selectedBtn = card.querySelector('.border-2');
                    if (!selectedBtn) return; // Skip if no feedback button is selected
                    
                    const sampleId = selectedBtn.getAttribute('data-sample-id');
                    const approved = selectedBtn.getAttribute('data-feedback') === 'true';
                    const textarea = card.querySelector('textarea');
                    const feedbackText = textarea ? textarea.value.trim() : '';
                    
                    console.log('Processing feedback for sample:', sampleId, {
                        approved: approved,
                        hasText: !!feedbackText,
                        button: selectedBtn
                    });
                    
                    feedbackItems.push({
                        sample_id: sampleId,
                        approved: approved,
                        text: feedbackText
                    });
                });
                
                console.log('Submitting feedback items:', feedbackItems);
                
                // Submit feedback to the server
                const response = await fetch('/api/submit-feedback', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token() }}'
                    },
                    body: JSON.stringify({
                        session_id: currentSessionId,
                        feedback: feedbackItems
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error || 'Failed to submit feedback');
                }
                
                const data = await response.json();
                
                if (data.status === 'completed') {
                    // Hide the feedback section while we process the final dataset
                    feedbackSection.classList.add('hidden');
                    
                    // Show loading state
                    setLoading(true);
                    
                    // Small delay to allow the UI to update
                    setTimeout(() => {
                        // Show final dataset
                        displayFinalDataset(data.dataset, data.total_rows);
                    }, 300);
                } else {
                    // Show next batch of samples
                    feedbackSection.scrollIntoView({ behavior: 'smooth' });
                    displaySamplesForFeedback(data.samples, data.feedback_round);
                }
                
            } catch (error) {
                console.error('Error submitting feedback:', error);
                showError(error.message || 'Failed to submit feedback');
            } finally {
                setLoading(false);
            }
        }
        
        // Save dataset to server
        async function saveDataset(dataset, totalRows) {
            try {
                const response = await fetch('/api/save-dataset', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token() }}'
                    },
                    body: JSON.stringify({
                        session_id: currentSessionId,
                        dataset: dataset,
                        row_count: totalRows || dataset.length,
                        columns: datasetColumns
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to save dataset');
                }

                const result = await response.json();
                return result.dataset_id;
            } catch (error) {
                console.error('Error saving dataset:', error);
                return null;
            }
        }
        
        // Display the final dataset
        async function displayFinalDataset(dataset, totalRows) {
            if (!dataset || dataset.length === 0) {
                showError('No data was generated');
                return;
            }
            
            // Hide the feedback section and show loading
            const feedbackSection = document.getElementById('feedbackSection');
            if (feedbackSection) feedbackSection.classList.add('hidden');
            
            // Show loading while we process the data
            setLoading(true);
            
            // Store the dataset for download
            currentSamples = dataset;
            
            // Update the row count
            const finalRowCountEl = document.getElementById('finalRowCount');
            const rowCount = totalRows || dataset.length;
            if (finalRowCountEl) {
                finalRowCountEl.textContent = rowCount;
            }
            
            // Save the dataset to the server
            log('Saving dataset to server...', 'info');
            const datasetId = await saveDataset(dataset, rowCount);
            
            if (!datasetId) {
                showError('Failed to save dataset. Please try again.');
                setLoading(false);
                return;
            }
            
            // Update the download button with the new dataset ID
            const downloadBtn = document.getElementById('downloadDatasetBtn');
            if (downloadBtn) {
                downloadBtn.onclick = () => downloadDataset(datasetId);
            }
            
            // Display a preview of the dataset
            displaySampleData(dataset);
            
            // Show the result section
            const resultSection = document.getElementById('resultSection');
            if (resultSection) {
                resultSection.classList.remove('hidden');
                resultSection.scrollIntoView({ behavior: 'smooth' });
            }
            
            // Hide loading
            setLoading(false);
        }
        
        // Download the generated dataset
        async function downloadDataset(datasetId = null) {
            if (!datasetId && !currentSessionId) {
                showError('No dataset found');
                return;
            }
            
            try {
                setLoading(true);
                
                // If no dataset ID is provided, try to get the latest one
                const idToUse = datasetId || currentSessionId;
                
                // Get the dataset from the server
                const response = await fetch(`/api/datasets/${idToUse}`);
                if (!response.ok) {
                    throw new Error('Failed to get dataset information');
                }
                
                const data = await response.json();
                
                // Create a download link for the dataset
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `dataset_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                URL.revokeObjectURL(url);
                a.remove();
                
            } catch (error) {
                console.error('Error downloading dataset:', error);
                showError(error.message || 'Failed to download dataset');
            } finally {
                setLoading(false);
            }
        }
        
        // Display sample data in a table
        function displaySampleData(data) {
            if (!data || data.length === 0) {
                return;
            }
            
            // Get container and clear it
            const sampleDataContainer = document.getElementById('sampleDataContainer');
            if (!sampleDataContainer) {
                console.error('sampleDataContainer not found');
                return;
            }
            
            // Use the stored column definitions if available, otherwise get from first object
            let headers = [];
            if (datasetColumns && datasetColumns.length > 0) {
                // Use the original column order from the form
                headers = [...datasetColumns];
                
                // Add any additional columns that might be in the data but not in the original columns
                const firstItem = data[0] || {};
                Object.keys(firstItem).forEach(key => {
                    if (!headers.includes(key)) {
                        headers.push(key);
                    }
                });
            } else {
                // Fallback: get headers from first object
                const firstItem = data[0] || {};
                headers = Object.keys(firstItem);
            }
            
            // Convert data to array of objects if it's not already
            const displayData = Array.isArray(data) ? data : [data];
            
            // Create table HTML
            let html = `
                <div class="flex flex-col">
                    <div class="-my-2 overflow-x-auto sm:-mx-6 lg:-mx-8">
                        <div class="py-2 align-middle inline-block min-w-full sm:px-6 lg:px-8">
                            <div class="shadow overflow-hidden border-b border-gray-200 sm:rounded-lg">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>`;
            
            
            // Table headers
            headers.forEach(header => {
                html += `
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        ${header}
                    </th>`;
            });
            
            html += `
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">`;
            
            // Table rows (limit to 10 for preview)
            displayData.slice(0, 10).forEach(row => {
                html += '<tr class="hover:bg-gray-50">';
                headers.forEach(header => {
                    let cellContent = row[header];
                    if (cellContent === undefined || cellContent === null) {
                        cellContent = '';
                    } else if (typeof cellContent === 'object') {
                        cellContent = JSON.stringify(cellContent);
                    } else {
                        cellContent = String(cellContent);
                    }
                    
                    if (cellContent.length > 100) {
                        cellContent = cellContent.substring(0, 100) + '...';
                    }
                    
                    // Escape HTML in cell content to prevent XSS
                    const escapedContent = cellContent
                        .replace(/&/g, '&amp;')
                        .replace(/</g, '&lt;')
                        .replace(/>/g, '&gt;')
                        .replace(/"/g, '&quot;')
                        .replace(/'/g, '&#039;');
                    
                    html += `
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" title="${escapedContent}">
                            ${escapedContent}
                        </td>`;
                });
                html += '</tr>';
            });
            
            // Add a row showing "..." if there are more rows
            if (displayData.length > 10) {
                html += `
                    <tr>
                        <td colspan="${headers.length}" class="px-6 py-2 text-center text-sm text-gray-500">
                            ... and ${displayData.length - 10} more rows
                        </td>
                    </tr>`;
            }
            
            // Close all the HTML tags
            html += `
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>`;
            
            sampleDataContainer.innerHTML = html;
        }
        
        // Show error message
        function showError(message) {
            // Create or update error message element
            let errorEl = document.getElementById('errorMessage');
            if (!errorEl) {
                errorEl = document.createElement('div');
                errorEl.id = 'errorMessage';
                errorEl.className = 'mb-4 p-4 bg-red-50 border-l-4 border-red-400 rounded';
                form.parentNode.insertBefore(errorEl, form);
            }
            
            errorEl.innerHTML = `
                <div class="flex">
                    <div class="flex-shrink-0">
                        <svg class="h-5 w-5 text-red-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                        </svg>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm text-red-700">
                            ${message}
                        </p>
                    </div>
                </div>
            `;
            
            // Scroll to error
            errorEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
            
            // Remove error after 5 seconds
            setTimeout(() => {
                if (errorEl) {
                    errorEl.style.opacity = '0';
                    setTimeout(() => errorEl.remove(), 300);
                }
            }, 5000);
        }
        
        // Auto-resize textarea function
        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = (textarea.scrollHeight) + 'px';
        }
        
        // Add styles for logs
        const style = document.createElement('style');
        style.textContent = `
            .log-entry {
                padding: 4px 0;
                border-bottom: 1px solid #f3f4f6;
                font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
                font-size: 0.875rem;
                line-height: 1.25rem;
            }
            .log-entry:last-child {
                border-bottom: none;
            }
            .log-entry.info {
                color: #4b5563;
            }
            .log-entry.success {
                color: #059669;
            }
            .log-entry.error {
                color: #dc2626;
            }
            .log-entry.warning {
                color: #d97706;
            }
            #logContainer {
                scrollbar-width: thin;
                scrollbar-color: #9ca3af #f3f4f6;
            }
            #logContainer::-webkit-scrollbar {
                width: 6px;
            }
            #logContainer::-webkit-scrollbar-track {
                background: #f3f4f6;
                border-radius: 3px;
            }
            #logContainer::-webkit-scrollbar-thumb {
                background-color: #9ca3af;
                border-radius: 3px;
            }`;
        document.head.appendChild(style);
        
        // Global error handler
        window.addEventListener('error', function(e) {
            console.error('Unhandled error:', e);
            const errorMessage = e.message || 'An unknown error occurred';
            const errorElement = document.createElement('div');
            errorElement.className = 'fixed bottom-4 right-4 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded';
            errorElement.role = 'alert';
            errorElement.innerHTML = `
                <strong class="font-bold">Error: </strong>
                <span class="block sm:inline">${errorMessage}</span>
            `;
            document.body.appendChild(errorElement);
            
            // Remove error message after 10 seconds
            setTimeout(() => {
                if (errorElement && errorElement.parentNode) {
                    errorElement.remove();
                }
            }, 10000);
        });
        } catch (error) {
            console.error('Error during initialization:', error);
            showError('An error occurred while initializing the page. Please refresh and try again.');
        }
    }); // Close the DOMContentLoaded event listener
</script>

<style>
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .fade-in {
        animation: fadeIn 0.3s ease-out forwards;
    }
    
    .log-entry {
        opacity: 0;
        animation: fadeIn 0.3s ease-out forwards;
    }
    
    .log-entry:nth-child(1) { animation-delay: 0.1s; }
    .log-entry:nth-child(2) { animation-delay: 0.2s; }
    .log-entry:nth-child(3) { animation-delay: 0.3s; }
    
    /* Smooth transitions for showing/hiding sections */
    .hidden-section {
        display: none;
        opacity: 0;
        transition: opacity 0.3s ease-in-out;
    }
    
    .visible-section {
        display: block;
        opacity: 1;
        transition: opacity 0.3s ease-in-out;
    }
</style>

{% endblock %}
